## é”™è¯¯ä¿¡æ¯

### **`perror`**

è¾“å‡ºæ ‡å‡†é”™è¯¯ä¿¡æ¯åœ¨ C è¯­è¨€ä¸­ï¼Œ`perror` æ˜¯ä¸€ä¸ªæ ‡å‡†åº“å‡½æ•°ï¼Œç”¨äºå°†ä¸ **å½“å‰ `errno` å€¼ç›¸å…³è”çš„é”™è¯¯ä¿¡æ¯** æ‰“å°åˆ°æ ‡å‡†é”™è¯¯æµï¼ˆ`stderr`ï¼‰ã€‚

ä»£ç ç¤ºä¾‹

```c
#include <stdio.h>
#include <unistd.h>

int main(int argc, char *argv[]) {
  // åœ¨æ²¡æœ‰é”™è¯¯errnoçš„æƒ…å†µä¸‹ï¼Œå°±ä¼šè¾“å‡ºSuccess
  perror("this is perror demo");
  sleep(1);
  return 0;
}

```

### **`errno`**

è‡ªå®šä¹‰é”™è¯¯

```c
#include <stdio.h>
#include <string.h>
#include <errno.h>

void my_perror(const char *s) {
    if (s && *s) {
        fprintf(stderr, "%s: %s\n", s, strerror(errno));
    } else {
        fprintf(stderr, "%s\n", strerror(errno));
    }
}
```



## æ–‡ä»¶æµå¤„ç†

### **`fopen`**

æ‰“å¼€æ–‡ä»¶

### **`fclose`**

å…³é—­æ–‡ä»¶

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main(int argc, char *argv[]) {
  //æ‰“å¼€æ–‡ä»¶
  FILE *fp = NULL;
  if ((fp = fopen("demo2.c", "w")) == NULL) {
    perror("fopen fail");
    exit(1);
  }
  printf("fopen success\n");

  fprintf(fp, "Hello, world!\n");
  if (fclose(fp) != 0) {
    perror("fclose failed");
  }
  return 0;
}
```

æ‰“å¼€æ¨¡å¼


| æ¨¡å¼ | å«ä¹‰ | æ˜¯å¦åˆ›å»ºæ–‡ä»¶ | æ˜¯å¦æ¸…ç©ºå†…å®¹ | æ–‡ä»¶æŒ‡é’ˆåˆå§‹ä½ç½® |
|------|------|---------------|----------------|------------------|
| `"r"` | åªè¯» | âŒ å¿…é¡»å­˜åœ¨ | âŒ | å¼€å¤´ |
| `"w"` | åªå†™ | âœ… ä¸å­˜åœ¨åˆ™åˆ›å»º | âœ… å­˜åœ¨åˆ™æ¸…ç©º | å¼€å¤´ |
| `"a"` | è¿½åŠ å†™ | âœ… ä¸å­˜åœ¨åˆ™åˆ›å»º | âŒ | æœ«å°¾ |
| `"r+"` | è¯»å†™ | âŒ å¿…é¡»å­˜åœ¨ | âŒ | å¼€å¤´ |
| `"w+"` | è¯»å†™ | âœ… ä¸å­˜åœ¨åˆ™åˆ›å»º | âœ… å­˜åœ¨åˆ™æ¸…ç©º | å¼€å¤´ |
| `"a+"` | è¯»å†™ï¼ˆå¯è¯»ï¼Œå†™å§‹ç»ˆè¿½åŠ ï¼‰ | âœ… ä¸å­˜åœ¨åˆ™åˆ›å»º | âŒ | æœ«å°¾ |

> âš ï¸ æ³¨æ„ï¼š
> - æ‰€æœ‰å†™æ“ä½œï¼ˆ`w`ã€`w+`ï¼‰ä¼š**æˆªæ–­ï¼ˆtruncateï¼‰**å·²å­˜åœ¨çš„æ–‡ä»¶ï¼
> - `"a"` å’Œ `"a+"` æ¨¡å¼ä¸‹ï¼Œ**å³ä½¿ä½¿ç”¨ `fseek` æ”¹å˜å†™ä½ç½®ï¼Œå†™æ“ä½œä»ä¼šå¼ºåˆ¶è¿½åŠ åˆ°æœ«å°¾**ï¼ˆè¿™æ˜¯ POSIX å’Œ C æ ‡å‡†çš„è¦æ±‚ï¼‰ã€‚



## å­—ç¬¦å¤„ç†

### **`fgetc`**

ä»æµä¸­è¯»å–ä¸€ä¸ªå­—ç¬¦

ä»£ç ç¤ºä¾‹

```c
#include <stdio.h>
// æ³¨æ„ï¼šå¿…é¡»ç”¨ int ç±»å‹æ¥æ”¶è¿”å›å€¼ï¼Œä¸èƒ½ç”¨ charï¼Œå¦åˆ™æ— æ³•åŒºåˆ† 0xFF å­—èŠ‚å’Œ EOFã€‚
int c;
while ((c = fgetc(fp)) != EOF) {
    putchar(c); // æˆ–å¤„ç†å­—ç¬¦
}
```

### **`fputc`**

å‘æµä¸­å†™å…¥ä¸€ä¸ªå­—ç¬¦

```c
fputc('A', stdout); // è¾“å‡º 'A'
fputc('\n', fp);    // å†™å…¥æ¢è¡Œåˆ°æ–‡ä»¶
```

### **`feof`**

æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æ–‡ä»¶æœ«å°¾

```c
int feof(FILE *stream);
```

### **`ferror`**

æ£€æŸ¥æµæ˜¯å¦å‘ç”Ÿé”™è¯¯

```c
int c;
while ((c = fgetc(fp)) != EOF) {
    // å¤„ç†å­—ç¬¦
}
if (ferror(fp)) {
    perror("è¯»å–æ–‡ä»¶æ—¶å‡ºé”™");
} else if (feof(fp)) {
    printf("æ­£å¸¸è¯»å–åˆ°æ–‡ä»¶æœ«å°¾\n");
}
```



## å­—ç¬¦ä¸²å¤„ç†

### **`fgets`**

ä»æµä¸­è¯»å–ä¸€è¡Œï¼ˆå¸¦é•¿åº¦é™åˆ¶ï¼Œ**å®‰å…¨**ï¼‰

```c
// ä» stream æœ€å¤šè¯»å– size - 1 ä¸ªå­—ç¬¦ï¼Œæˆ–ç›´åˆ°é‡åˆ°æ¢è¡Œç¬¦ \n æˆ– EOFã€‚
// 1.ä¼šå°†è¯»å–åˆ°çš„ æ¢è¡Œç¬¦ \n ä¿ç•™åœ¨å­—ç¬¦ä¸²ä¸­ï¼ˆå¦‚æœè¯»åˆ°äº†ï¼‰ã€‚
// 2.è‡ªåŠ¨åœ¨æœ«å°¾æ·»åŠ  \0ã€‚
char *fgets(char *str, int size, FILE *stream);
```



### **`fputs`**

å‘æµä¸­å†™å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆä¸è‡ªåŠ¨åŠ æ¢è¡Œï¼‰

```c
// å°†å­—ç¬¦ä¸² strï¼ˆä¸åŒ…æ‹¬ç»“å°¾çš„ \0ï¼‰å†™å…¥ streamã€‚
// 1.ä¸ä¼šè‡ªåŠ¨æ·»åŠ æ¢è¡Œç¬¦ \nï¼
int fputs(const char *str, FILE *stream);
```



ç¤ºä¾‹

```c
// é€è¡Œè¯»å–
char line[256];
FILE *fp = fopen("data.txt", "r");
if (fp) {
    while (fgets(line, sizeof(line), fp)) {
        // å¤„ç†æ¯ä¸€è¡Œ
        line[strcspn(line, "\n")] = '\0'; //ç§»é™¤æ¢è¡Œ
        printf("è¡Œ: %s\n", line);
    }
    fclose(fp);
}
```



## å­—èŠ‚æµå¤„ç†

### **`fread`**

è¯»å–æ–‡ä»¶æŒ‡å®šé•¿åº¦çš„å­—èŠ‚æ•°æ®

```c
#include <stdio.h>

// ptrï¼šæŒ‡å‘ç›®æ ‡ç¼“å†²åŒºçš„æŒ‡é’ˆï¼ˆç”¨äºå­˜æ”¾è¯»å–çš„æ•°æ®ï¼‰ã€‚
// sizeï¼šæ¯ä¸ªå…ƒç´ çš„å­—èŠ‚æ•°ï¼ˆå¦‚ sizeof(int)ï¼‰ã€‚
// nmembï¼šè¦è¯»å–çš„å…ƒç´ ä¸ªæ•°ã€‚
// streamï¼šè¾“å…¥æµï¼ˆå¦‚æ–‡ä»¶æŒ‡é’ˆï¼‰ã€‚
size_t fread(void *ptr, size_t size, size_t nmemb, FILE *stream);
// è¿”å›æˆåŠŸè¯»å–çš„å…ƒç´ ä¸ªæ•°ï¼ˆä¸æ˜¯å­—èŠ‚æ•°ï¼ï¼‰ã€‚
// å¦‚æœè¿”å›å€¼ å°äº nmembï¼Œå¯èƒ½æ˜¯ï¼šåˆ°è¾¾æ–‡ä»¶æœ«å°¾ï¼ˆEOFï¼‰ã€å‘ç”Ÿè¯»å–é”™è¯¯ï¼›å¯é€šè¿‡ feof() æˆ– ferror() åˆ¤æ–­åŸå› ã€‚
```

### **`fwrite`**

å‘æµä¸­å†™å…¥æ•°æ®å—

```c
// ptrï¼šæŒ‡å‘æºæ•°æ®ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚
// sizeï¼šæ¯ä¸ªå…ƒç´ çš„å­—èŠ‚æ•°ã€‚
// nmembï¼šè¦å†™å…¥çš„å…ƒç´ ä¸ªæ•°ã€‚
// streamï¼šè¾“å‡ºæµã€‚
size_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *stream);
// è¿”å›æˆåŠŸå†™å…¥çš„å…ƒç´ ä¸ªæ•°ã€‚
// è‹¥è¿”å›å€¼ å°äº nmembï¼Œè¯´æ˜å†™å…¥å¤±è´¥ï¼ˆå¦‚ç£ç›˜æ»¡ã€æƒé™ä¸è¶³ç­‰ï¼‰ã€‚
```


| æ¨¡å¼ç¤ºä¾‹ | ç±»å‹ | è¯´æ˜ |
|---------|------|------|
| `"rb"`  | äºŒè¿›åˆ¶åªè¯» | æ¨èç”¨äºè¯»å–å›¾ç‰‡ã€éŸ³é¢‘ç­‰ |
| `"wb"`  | äºŒè¿›åˆ¶åªå†™ | æ¨èç”¨äºå†™å…¥äºŒè¿›åˆ¶æ•°æ® |
| `"ab"`  | äºŒè¿›åˆ¶è¿½åŠ  | |
| `"r+b"` æˆ– `"rb+"` | äºŒè¿›åˆ¶è¯»å†™ | |
| `"w+b"` æˆ– `"wb+"` | äºŒè¿›åˆ¶è¯»å†™ï¼ˆæ¸…ç©ºï¼‰ | |
| `"a+b"` æˆ– `"ab+"` | äºŒè¿›åˆ¶è¯»å†™ï¼ˆè¿½åŠ ï¼‰ | |



**æ³¨æ„**ï¼šæ‰“å¼€äºŒè¿›åˆ¶æ–‡ä»¶å¿…é¡»ä½¿ç”¨ `"rb"` / `"wb"` æ¨¡å¼ï¼
åœ¨ Windows ä¸Šï¼Œæ–‡æœ¬æ¨¡å¼ä¼šè‡ªåŠ¨è½¬æ¢ `\n` â†” `\r\n`ï¼Œç ´åäºŒè¿›åˆ¶æ•°æ®ã€‚

ç¤ºä¾‹ï¼šè¯»å–äºŒè¿›åˆ¶æ–‡ä»¶

```c
#include <stdio.h>
#include <sys/types.h>

int main() {
    // å†™å…¥
    int data[] = {10, 20, 30, 40, 50};
    FILE *fp = fopen("numbers.bin", "wb");
    if (fp) {
        size_t written = fwrite(data, sizeof(int), 5, fp);
        printf("å†™å…¥ %zu ä¸ªæ•´æ•°\n", written);
        fclose(fp);
    }

    // è¯»å–
    int read_data[5];
    fp = fopen("numbers.bin", "rb");
    if (fp) {
        size_t read = fread(read_data, sizeof(int), 5, fp);
        printf("è¯»å– %zu ä¸ªæ•´æ•°: ", read);
        for (size_t i = 0; i < read; i++) {
            printf("%d ", read_data[i]);
        }
        fclose(fp);
    }
    return 0;
}
```

ç¤ºä¾‹ï¼šè¯»å†™ç»“æ„ä½“

```c
typedef struct {
    char name[20];
    int age;
    float score;
} Student;

int main() {
    Student s = {"Alice", 20, 95.5f};

    // å†™å…¥ç»“æ„ä½“
    FILE *fp = fopen("student.dat", "wb");
    fwrite(&s, sizeof(Student), 1, fp);
    fclose(fp);

    // è¯»å–ç»“æ„ä½“
    Student s2;
    fp = fopen("student.dat", "rb");
    fread(&s2, sizeof(Student), 1, fp);
    fclose(fp);

    printf("Name: %s, Age: %d, Score: %.1f\n", s2.name, s2.age, s2.score);
    return 0;
}
```

ç¤ºä¾‹ï¼šè¿”å›å€¼æ£€æŸ¥

```c
size_t result = fread(buffer, size, count, fp);
if (result != count) {
    if (feof(fp)) {
        printf("è¯»å–æ—¶åˆ°è¾¾æ–‡ä»¶æœ«å°¾\n");
    } else if (ferror(fp)) {
        perror("è¯»å–é”™è¯¯");
    }
}
```

```c
// å†™å…¥åæ£€æŸ¥ï¼ˆå°¤å…¶é‡è¦ï¼ï¼‰
if (fwrite(data, sizeof(data), 1, fp) != 1) {
    perror("å†™å…¥å¤±è´¥");
    // å¯èƒ½æ˜¯ç£ç›˜æ»¡ã€åªè¯»æ–‡ä»¶ç­‰
}
```

## æ–‡ä»¶ä½ç½®æŒ‡é’ˆå¤„ç†

### **`fseek`**

å°† `stream` çš„æ–‡ä»¶ä½ç½®æŒ‡é’ˆç§»åŠ¨åˆ°æŒ‡å®šä½ç½®ã€‚

```c
#include <stdio.h>

// streamï¼šæ–‡ä»¶æµæŒ‡é’ˆï¼ˆç”± fopen è¿”å›ï¼‰ã€‚
// offsetï¼šåç§»é‡ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œå¯æ­£å¯è´Ÿï¼‰ã€‚
// originï¼šèµ·å§‹å‚è€ƒç‚¹ï¼Œå–å€¼å¦‚ä¸‹ï¼š
// 		SEEK_SETï¼šæ–‡ä»¶å¼€å¤´ï¼ˆ0ï¼‰
//		SEEK_CURï¼šå½“å‰ä½ç½®ï¼ˆ1ï¼‰
//		SEEK_ENDï¼šæ–‡ä»¶æœ«å°¾ï¼ˆ2ï¼‰
int fseek(FILE *stream, long offset, int origin);
// è¿”å›å€¼ï¼šæˆåŠŸ0
```

ç¤ºä¾‹

```c
fseek(fp, 0, SEEK_SET);  // è·³åˆ°æ–‡ä»¶å¼€å¤´
fseek(fp, -10, SEEK_END); // è·³åˆ°å€’æ•°ç¬¬10å­—èŠ‚
fseek(fp, 5, SEEK_CUR);   // ä»å½“å‰ä½ç½®å‘åè·³5å­—èŠ‚
```



### **`ftell`**

 è¿”å›æ–‡ä»¶ä½ç½®æŒ‡é’ˆç›¸å¯¹äºæ–‡ä»¶å¼€å¤´çš„å­—èŠ‚åç§»é‡ã€‚

```c
long ftell(FILE *stream);
# æˆåŠŸï¼šå½“å‰ä½ç½®ï¼ˆlong ç±»å‹ï¼‰
# å¤±è´¥ï¼š-1L
```

ç¤ºä¾‹

```c
long pos = ftell(fp);
printf("å½“å‰åç§»: %ld å­—èŠ‚\n", pos);
```



### **`rewind`**

 é‡ç½®åˆ°æ–‡ä»¶å¼€å¤´ï¼ˆç­‰ä»·äº fseek(fp, 0L, SEEK_SET)ï¼‰

```c
// å°†æ–‡ä»¶ä½ç½®æŒ‡é’ˆè®¾ä¸º 0ï¼ˆæ–‡ä»¶å¼€å¤´ï¼‰
// åŒæ—¶æ¸…é™¤æµçš„é”™è¯¯æ ‡å¿—ï¼ˆerror indicatorï¼‰å’Œ EOF æ ‡å¿—
void rewind(FILE *stream);
```



ç»¼åˆæ¡ˆä¾‹

```c
/* è·å–æ–‡ä»¶å¤§å° */
long get_file_size(FILE *fp) {
    if (fseek(fp, 0, SEEK_END) != 0) return -1;
    long size = ftell(fp);
    rewind(fp); // é‡ç½®å›å¼€å¤´
    return size;
}
```



**æ³¨æ„**ï¼š `fseek` åœ¨ `"a"`ï¼ˆè¿½åŠ ï¼‰æ¨¡å¼ä¸‹çš„ç‰¹æ®Šè¡Œä¸º

- **å†™æ“ä½œå§‹ç»ˆè¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾**ï¼Œå³ä½¿ä½ ç”¨ `fseek` ç§»åŠ¨äº†ä½ç½®æŒ‡é’ˆï¼
- è¿™æ˜¯ C æ ‡å‡†å’Œ POSIX çš„å¼ºåˆ¶è¦æ±‚ã€‚

- å¯¹ **ç®¡é“ï¼ˆpipeï¼‰**ã€**å¥—æ¥å­—ï¼ˆsocketï¼‰**ã€**æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼Œè‹¥æ¥è‡ªç»ˆç«¯ï¼‰** ç­‰**ä¸æ”¯æŒéšæœºè®¿é—®çš„æµ**è°ƒç”¨ `fseek` ä¼šå¤±è´¥ã€‚


### **`fstat`**

è·å–æ–‡ä»¶å…ƒæ•°æ®

```c
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>
// fdï¼šå·²æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆç”± open()ã€dup() ç­‰è¿”å›ï¼‰
// bufï¼šæŒ‡å‘ struct stat çš„æŒ‡é’ˆï¼Œç”¨äºæ¥æ”¶æ–‡ä»¶ä¿¡æ¯
int fstat(int fd, struct stat *buf);
// æˆåŠŸï¼š0  å¤±è´¥ï¼š-1ï¼Œå¹¶è®¾ç½® errnoï¼ˆå¦‚ EBADF è¡¨ç¤ºæ— æ•ˆ fdï¼‰
```

statç»“æ„ä½“

```c
struct stat {
    dev_t     st_dev;         // æ–‡ä»¶æ‰€åœ¨è®¾å¤‡ ID
    ino_t     st_ino;         // inode å·ï¼ˆå”¯ä¸€æ ‡è¯†æ–‡ä»¶ï¼‰
    mode_t    st_mode;        // æ–‡ä»¶ç±»å‹ + æƒé™ä½
    nlink_t   st_nlink;       // ç¡¬é“¾æ¥æ•°
    uid_t     st_uid;         // æ‰€æœ‰è€…ç”¨æˆ· ID
    gid_t     st_gid;         // æ‰€æœ‰è€…ç»„ ID
    dev_t     st_rdev;        // è®¾å¤‡æ–‡ä»¶çš„è®¾å¤‡ IDï¼ˆä»…å¯¹è®¾å¤‡æ–‡ä»¶æœ‰æ•ˆï¼‰
    off_t     st_size;        // **æ–‡ä»¶å­—èŠ‚å¤§å°**ï¼ˆæ™®é€šæ–‡ä»¶ï¼‰
    time_t    st_atime;       // æœ€åè®¿é—®æ—¶é—´
    time_t    st_mtime;       // æœ€åä¿®æ”¹æ—¶é—´
    time_t    st_ctime;       // çŠ¶æ€å˜æ›´æ—¶é—´ï¼ˆå¦‚æƒé™ã€ç¡¬é“¾æ¥ï¼‰
    // ... å…¶ä»–å­—æ®µï¼ˆblksize_t st_blksize, blkcnt_t st_blocks ç­‰ï¼‰
};
```

ğŸ“Œ é‡ç‚¹å­—æ®µï¼š
> st_sizeï¼šè·å–æ–‡ä»¶å¤§å°ï¼ˆå¯¹æ™®é€šæ–‡ä»¶æœ‰æ•ˆï¼Œå¯¹ç›®å½•/ç®¡é“æ— æ„ä¹‰ï¼‰
> st_modeï¼šåŒ…å«æ–‡ä»¶ç±»å‹å’Œæƒé™ï¼ˆéœ€ç”¨å®è§£æï¼‰
> æ—¶é—´å­—æ®µï¼šè‡ª Unix çºªå…ƒï¼ˆ1970-01-01 UTCï¼‰ä»¥æ¥çš„ç§’æ•°

`st_mode`ç»“æ„ä½“æ–‡ä»¶ç±»å‹åˆ¤æ–­ä½¿ç”¨`S_IS***`å®

| å® | è¯´æ˜ |
|----|------|
| `S_ISREG(m)` | æ™®é€šæ–‡ä»¶ |
| `S_ISDIR(m)` | ç›®å½• |
| `S_ISCHR(m)` | å­—ç¬¦è®¾å¤‡ |
| `S_ISBLK(m)` | å—è®¾å¤‡ |
| `S_ISFIFO(m)` | FIFOï¼ˆå‘½åç®¡é“ï¼‰ |
| `S_ISLNK(m)` | ç¬¦å·é“¾æ¥ï¼ˆ**`fstat` ä¸ä¼šè¿”å›æ­¤ç±»å‹ï¼è§ä¸‹æ–‡**ï¼‰ |
| `S_ISSOCK(m)` | å¥—æ¥å­— |


ç¤ºä¾‹

```c
struct stat sb;
if (fstat(fd, &sb) == 0) {
    if (S_ISREG(sb.st_mode)) {
        printf("æ™®é€šæ–‡ä»¶ï¼Œå¤§å°: %ld å­—èŠ‚\n", sb.st_size);
    } else if (S_ISDIR(sb.st_mode)) {
        printf("è¿™æ˜¯ä¸€ä¸ªç›®å½•\n");
    }
}
```

ä¸æ ‡å‡†IOç»“åˆä½¿ç”¨éœ€è¦ç”¨åˆ°`fileno`å‡½æ•°
```c
FILE *fp = fopen("file.txt", "r");
if (fp) {
    int fd = fileno(fp); // è·å–åº•å±‚æ–‡ä»¶æè¿°ç¬¦
    struct stat sb;
    if (fstat(fd, &sb) == 0) {
        printf("å¤§å°: %ld\n", sb.st_size);
    }
    fclose(fp);
}
```


## æ ¼å¼åŒ–å¤„ç†

**è¾“å‡ºç±»**

### **`printf`**

æ ¼å¼åŒ–è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆ`stdout`ï¼‰

```c
// æŒ‰ format æ ¼å¼å°†å‚æ•°è¾“å‡ºåˆ° stdoutã€‚
int printf(const char *format, ...);
```



### **`fprintf`**

æ ¼å¼åŒ–è¾“å‡ºåˆ°æŒ‡å®šæµï¼ˆå¦‚æ–‡ä»¶ï¼‰

```c
// å°†æ ¼å¼åŒ–å­—ç¬¦ä¸²å†™å…¥ streamï¼ˆå¦‚ stdoutã€stderrã€æ–‡ä»¶æŒ‡é’ˆç­‰ï¼‰ã€‚
int fprintf(FILE *stream, const tr *format, ...);
```



### **`sprintf`**

æ ¼å¼åŒ–è¾“å‡ºåˆ°å­—ç¬¦æ•°ç»„ï¼ˆæœ‰ç¼“å†²åŒºæº¢å‡ºé£é™©ï¼ï¼‰

```c
int sprintf(char *str, const char *format, ...);
```



### **`snprintf`**

å®‰å…¨ç‰ˆ sprintfï¼ˆæ¨èä½¿ç”¨ï¼‰

```c
// æœ€å¤šå†™å…¥ size - 1 ä¸ªå­—ç¬¦ï¼Œå¹¶è‡ªåŠ¨æ·»åŠ  \0ã€‚
int snprintf(char *str, size_t size, const char *format, ...);
```



**è¾“å…¥ç±»**

### **`scanf`**

ä»æ ‡å‡†è¾“å…¥è¯»å–å¹¶è§£æ

```c
// ä» stdin è¯»å–è¾“å…¥ï¼ŒæŒ‰ format è§£æåˆ°å˜é‡åœ°å€ã€‚
int scanf(const char *format, ...);
// è¿”å›å€¼ï¼šæˆåŠŸèµ‹å€¼çš„å˜é‡ä¸ªæ•°ï¼ŒEOF è¡¨ç¤ºè¯»å–å¤±è´¥ã€‚
```



### **`fscanf`**

 ä»æŒ‡å®šæµè¯»å–å¹¶è§£æ

```c
// ä» streamï¼ˆå¦‚æ–‡ä»¶ï¼‰è¯»å–å¹¶è§£æã€‚
int fscanf(FILE *stream, const char *format, ...);
```



### **`sscanf`**

ä»å­—ç¬¦ä¸²ä¸­è§£ææ•°æ®

```c
// ä»å†…å­˜ä¸­çš„å­—ç¬¦ä¸² str è§£ææ•°æ®ï¼ˆä¸æ¶‰åŠ I/Oï¼‰ã€‚
// éå¸¸æœ‰ç”¨ï¼šç”¨äºè§£æé…ç½®è¡Œã€æ—¥å¿—å­—æ®µç­‰ã€‚
int sscanf(const char *str, const char *format, ...);
```

ç¤ºä¾‹

```c
char line[] = "2025-11-30 15:30:00";
int year, month, day, hour, min, sec;
sscanf(line, "%d-%d-%d %d:%d:%d", &year, &month, &day, &hour, &min, &sec);
```



**æ³¨æ„äº‹é¡¹**ï¼šscanf / sprintf çš„ç¼“å†²åŒºæº¢å‡º

```text
    %sã€%[ ç­‰ä¸æŒ‡å®šå®½åº¦æ—¶éå¸¸å±é™©ã€‚
    è§£å†³æ–¹æ¡ˆï¼š
        è¾“å…¥ï¼šç”¨ fgets + sscanfï¼ˆæ¨èï¼‰
        è¾“å‡ºï¼šç”¨ snprintf
```

ç¤ºä¾‹

```c
char input[100];
if (fgets(input, sizeof(input), stdin)) {
    input[strcspn(input, "\n")] = '\0'; // å»æ¢è¡Œ
    sscanf(input, "%d", &num);
}
```



## è¿›ç¨‹æ“ä½œå‡½æ•°
### **`fork`**

 åˆ›å»ºå­è¿›ç¨‹ï¼ˆæœ€åŸºç¡€çš„è¿›ç¨‹åˆ›å»ºæ–¹å¼ï¼‰ï¼Œé€šå¸¸ä¸execç³»åˆ—å‡½æ•°é…åˆä½¿ç”¨ï¼Œåœ¨å­è¿›ç¨‹ä¸­ä½¿ç”¨execæ›¿æ¢æˆæ–°ç¨‹åº

```c
#include <unistd.h>
// åˆ›å»ºä¸€ä¸ªä¸å½“å‰è¿›ç¨‹å‡ ä¹å®Œå…¨ç›¸åŒçš„å­è¿›ç¨‹ã€‚
pid_t fork(void);
// åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼šè¿”å› å­è¿›ç¨‹çš„ PIDï¼ˆ>0ï¼‰
// åœ¨å­è¿›ç¨‹ä¸­ï¼šè¿”å› 0
// å¤±è´¥ï¼šè¿”å› -1ï¼ˆå¦‚èµ„æºä¸è¶³ï¼‰
```

ç¤ºä¾‹

```c
pid_t pid = fork();
if (pid == 0) {
    // å­è¿›ç¨‹
    execl("/bin/ls", "ls", "-l", NULL);
    perror("execl failed");
    _exit(1);
} else if (pid > 0) {
    // çˆ¶è¿›ç¨‹
    wait(NULL); // ç­‰å¾…å­è¿›ç¨‹ç»“æŸ
} else {
    perror("fork failed");
}
```



### **`exec`**

å°†å½“å‰è¿›ç¨‹å®Œæ•´æ›¿æ¢ä¸ºæ–°ç¨‹åºçš„å†…å®¹ï¼ŒåŒ…å«å†…å­˜å­—èŠ‚å˜é‡ä»£ç ç­‰


| å‡½æ•° | å‚æ•°å½¢å¼ | æ˜¯å¦ä½¿ç”¨ PATH | æ˜¯å¦æ¥å—å‚æ•°æ•°ç»„ |
|------|--------|---------------|----------------|
| `execl`  | `execl(path, arg0, arg1, ..., NULL)` | âŒ éœ€å®Œæ•´è·¯å¾„ | âŒ åˆ—è¡¨ |
| `execv`  | `execv(path, argv[])` | âŒ | âœ… |
| `execle` | `execle(path, arg0, ..., NULL, envp[])` | âŒ | âŒ + è‡ªå®šä¹‰ç¯å¢ƒ |
| `execve` | `execve(path, argv[], envp[])` | âŒ | âœ… + è‡ªå®šä¹‰ç¯å¢ƒ |
| `execvp` | `execvp(file, argv[])` | âœ… è‡ªåŠ¨æœç´¢ PATH | âœ… |
| `execvpe`| `execvpe(file, argv[], envp[])` | âœ… | âœ… + è‡ªå®šä¹‰ç¯å¢ƒ |

âœ… **æœ€å¸¸ç”¨ç»„åˆ**ï¼š
```c
// ä½¿ç”¨ PATH æœç´¢ "ls"
execvp("ls", (char *[]){"ls", "-l", NULL});

// æˆ–
char *args[] = {"ls", "-l", NULL};
execvp("ls", args);
```

> âš ï¸ **æ³¨æ„**ï¼š
> - `exec` **æˆåŠŸæ—¶ä¸ä¼šè¿”å›**ï¼å½“å‰è¿›ç¨‹æ˜ åƒè¢«æ–°ç¨‹åºå®Œå…¨æ›¿æ¢ã€‚
> - è‹¥è¿”å›ï¼Œè¯´æ˜ **`exec` å¤±è´¥**ï¼Œåº”è°ƒç”¨ `perror` å¹¶é€€å‡ºï¼ˆå¦‚ `_exit(1)`ï¼‰ã€‚



### **`wait`**

å›æ”¶å­è¿›ç¨‹èµ„æºï¼Œç­‰å¾…ä»»æ„ä¸€ä¸ªå­è¿›ç¨‹ç»“æŸ

```c
#include <sys/wait.h>
#include <sys/types.h>

//é˜»å¡ç›´åˆ°ä»»æ„ä¸€ä¸ªå­è¿›ç¨‹ç»ˆæ­¢ã€‚
pid_t wait(int *status);
//status å¯ç”¨äºæ£€æŸ¥å­è¿›ç¨‹é€€å‡ºçŠ¶æ€ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚
```



### **`waitpid`**

æ›´çµæ´»çš„ç­‰å¾…ï¼ˆæ¨èï¼‰

```c
//pidï¼š
//    >0ï¼šç­‰å¾…æŒ‡å®š PID çš„å­è¿›ç¨‹
//    -1ï¼šç­‰å¾…ä»»æ„å­è¿›ç¨‹ï¼ˆç­‰åŒ waitï¼‰
//    0ï¼šç­‰å¾…åŒç»„å­è¿›ç¨‹
//optionsï¼š
//    0ï¼šé˜»å¡ç­‰å¾…
//    WNOHANGï¼šéé˜»å¡ï¼Œè‹¥æ— å­è¿›ç¨‹é€€å‡ºåˆ™ç«‹å³è¿”å› 0
//    WUNTRACEDï¼šä¹ŸæŠ¥å‘Šå› ä¿¡å·åœæ­¢çš„å­è¿›ç¨‹
pid_t waitpid(pid_t pid, int *status, int options);
```

æ¡ˆä¾‹

```c
int status;
pid_t pid = waitpid(child_pid, &status, 0);
//æ£€æŸ¥å­è¿›ç¨‹é€€å‡ºçŠ¶æ€ï¼ˆä½¿ç”¨å®ï¼‰
if (WIFEXITED(status)) {
    printf("å­è¿›ç¨‹æ­£å¸¸é€€å‡ºï¼ŒçŠ¶æ€ç : %d\n", WEXITSTATUS(status));
} else if (WIFSIGNALED(status)) {
    printf("å­è¿›ç¨‹è¢«ä¿¡å· %d æ€æ­»\n", WTERMSIG(status));
}
```

æœ€ä½³å®è·µ

 ```c
 // å¯ä»¥é…åˆä¿¡å·å¤„ç†å‡½æ•°ï¼Œæ— é˜»å¡å›æ”¶é€€å‡ºçš„å­è¿›ç¨‹ï¼Œæ¡ˆä¾‹åœ¨ä¿¡å·ç¤ºä¾‹éƒ¨åˆ†
 waitpid(-1, NULL, WNOHANG)
 ```



### **`getpid`**

è·å–å½“å‰è¿›ç¨‹ID

```c
#include <unistd.h>
pid_t getpid(void);    // è·å–å½“å‰è¿›ç¨‹ PID
pid_t getppid(void);   // è·å–çˆ¶è¿›ç¨‹ PID
```



### **`exit`**

é€€å‡ºè¿›ç¨‹

```c
void exit(int status);      // æ ‡å‡†åº“å‡½æ•°ï¼Œä¼šè°ƒç”¨ atexit æ³¨å†Œçš„å‡½æ•° + åˆ·æ–° stdio ç¼“å†²åŒº
void _exit(int status);     // ç³»ç»Ÿè°ƒç”¨ï¼Œç«‹å³ç»ˆæ­¢ï¼Œä¸æ¸…ç† stdio
```

> âœ… **è§„åˆ™**ï¼š
>
> - ä¸»ç¨‹åºä¸­ç”¨ `exit()`
> - `fork` åçš„å­è¿›ç¨‹ä¸­è‹¥ `exec` å¤±è´¥ï¼Œç”¨ `_exit()`ï¼ˆé¿å… double flushï¼‰



### **`system`**

åˆ›å»ºæ–°è¿›ç¨‹å¹¶æ‰§è¡Œå‘½ä»¤

```c
#include <stdlib.h>

//è°ƒç”¨ /bin/sh -c command æ‰§è¡Œ shell å‘½ä»¤ã€‚
//ç­‰ä»·äº fork + exec + wait çš„å°è£…ã€‚
int system(const char *command);
//è¿”å›å€¼ï¼šå‘½ä»¤çš„é€€å‡ºçŠ¶æ€ï¼ˆéœ€ç”¨ WEXITSTATUS è§£æï¼‰ã€‚
```



### **`setsid`**

è„±ç¦»ç»ˆç«¯æ§åˆ¶ï¼Œç”¨äºå®ç°å®ˆæŠ¤è¿›ç¨‹

```c
#include <unistd.h>

// åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ï¼ˆsessionï¼‰ï¼Œå¹¶ä½¿è°ƒç”¨è¿›ç¨‹æˆä¸ºè¯¥ä¼šè¯çš„ä¼šè¯é¦–è¿›ç¨‹ï¼ˆsession leaderï¼‰ å’Œæ–°è¿›ç¨‹ç»„çš„ç»„é•¿ï¼ˆprocess group leaderï¼‰ã€‚
pid_t setsid(void);
// æˆåŠŸï¼šè¿”å›æ–°ä¼šè¯çš„ä¼šè¯ IDï¼ˆå³è°ƒç”¨è¿›ç¨‹çš„ PIDï¼‰
// å¤±è´¥ï¼šè¿”å› -1ï¼Œå¹¶è®¾ç½® errnoï¼ˆå¸¸è§é”™è¯¯è§ä¸‹æ–‡ï¼‰
```

- **æœ€å…³é”®çš„æ•ˆæœ**ï¼šè¯¥è¿›ç¨‹**ä¸å†æ‹¥æœ‰æ§åˆ¶ç»ˆç«¯**ã€‚
- å³ä½¿æ˜¯ä»ç»ˆç«¯å¯åŠ¨çš„ç¨‹åºï¼Œè°ƒç”¨ `setsid()` åï¼š
  - ä¸å†æ¥æ”¶ `Ctrl+C`ï¼ˆ`SIGINT`ï¼‰
  - ä¸å†æ¥æ”¶ `Ctrl+\`ï¼ˆ`SIGQUIT`ï¼‰
  - ç»ˆç«¯å…³é—­ï¼ˆå¦‚ SSH æ–­å¼€ï¼‰**ä¸ä¼šå¯¼è‡´è¿›ç¨‹ç»ˆæ­¢**

ç¤ºä¾‹

```c
#include <unistd.h>
#include <sys/stat.h>
#include <stdlib.h>

int main() {
    // Step 1: ç¬¬ä¸€æ¬¡ fork â€”â€” çˆ¶è¿›ç¨‹é€€å‡ºï¼Œå­è¿›ç¨‹ç»§ç»­
    if (fork() != 0) {
        exit(0);  // çˆ¶è¿›ç¨‹é€€å‡ºï¼Œå­è¿›ç¨‹è¢« init æ¥ç®¡
    }

    // Step 2: åˆ›å»ºæ–°ä¼šè¯ï¼ˆè„±ç¦»ç»ˆç«¯ï¼‰
    if (setsid() == -1) {
        perror("setsid failed");
        exit(1);
    }

    // Step 3: ç¬¬äºŒæ¬¡ fork â€”â€” ç¡®ä¿ä¸ä¼šæˆä¸ºä¼šè¯é¦–è¿›ç¨‹ï¼ˆé¿å…æ„å¤–è·å–æ§åˆ¶ç»ˆç«¯ï¼‰
    if (fork() != 0) {
        exit(0);  // æ–°çš„å­è¿›ç¨‹ä¸å†æ˜¯ä¼šè¯é¦–è¿›ç¨‹
    }

    // Step 4: æ¸…ç†ç¯å¢ƒ
    umask(0);                // é‡ç½®æ–‡ä»¶æ©ç 
    chdir("/");              // åˆ‡æ¢å·¥ä½œç›®å½•ï¼ˆé¿å…å ç”¨å¯å¸è½½æ–‡ä»¶ç³»ç»Ÿï¼‰
    close(STDIN_FILENO);     // å…³é—­æ ‡å‡†è¾“å…¥
    close(STDOUT_FILENO);    // å…³é—­æ ‡å‡†è¾“å‡º
    close(STDERR_FILENO);    // å…³é—­æ ‡å‡†é”™è¯¯ï¼ˆæˆ–é‡å®šå‘åˆ°æ—¥å¿—ï¼‰

    // Step 5: ä¸»å¾ªç¯
    while (1) {
        // æ‰§è¡Œå®ˆæŠ¤ä»»åŠ¡
        sleep(10);
    }
    return 0;
}
```







## æ¥æ”¶ä¿¡å·

### **`signal`**

**è½¯ä»¶ä¸­æ–­**ï¼Œç”±å†…æ ¸æˆ–è¿›ç¨‹å‘é€ç»™ç›®æ ‡è¿›ç¨‹ã€‚ä¼¼äºç¡¬ä»¶ä¸­æ–­ï¼Œ**æ‰“æ–­å½“å‰æ‰§è¡Œæµ**ï¼Œè½¬è€Œæ‰§è¡Œ**ä¿¡å·å¤„ç†å‡½æ•°ï¼ˆSignal Handlerï¼‰**ã€‚

| ä¿¡å· | ç¼–å· | é»˜è®¤è¡Œä¸º | è§¦å‘åœºæ™¯ |
|------|-----|---------|--------|
| `SIGINT` | 2 | ç»ˆæ­¢è¿›ç¨‹ | ç”¨æˆ·æŒ‰ **Ctrl+C** |
| `SIGQUIT` | 3 | ç»ˆæ­¢ + ç”Ÿæˆ core dump | ç”¨æˆ·æŒ‰ **Ctrl+\** |
| `SIGKILL` | 9 | **å¼ºåˆ¶ç»ˆæ­¢**ï¼ˆä¸å¯æ•è·/å¿½ç•¥ï¼‰ | `kill -9` |
| `SIGTERM` | 15 | ç»ˆæ­¢ï¼ˆå¯æ•è·ï¼‰ | `kill` é»˜è®¤ä¿¡å·ï¼Œ**ä¼˜é›…ç»ˆæ­¢** |
| `SIGCHLD` | 17/20 | å¿½ç•¥ï¼ˆé»˜è®¤ï¼‰ | å­è¿›ç¨‹çŠ¶æ€æ”¹å˜ï¼ˆé€€å‡º/åœæ­¢ï¼‰ |
| `SIGSTOP` | 19 | æš‚åœè¿›ç¨‹ï¼ˆä¸å¯æ•è·ï¼‰ | `kill -STOP` |
| `SIGCONT` | 18 | ç»§ç»­æ‰§è¡Œ | `kill -CONT` |
| `SIGUSR1` / `SIGUSR2` | 10/12 | ç»ˆæ­¢ | ç”¨æˆ·è‡ªå®šä¹‰ä¿¡å· |


> âš ï¸ **å…³é”®è§„åˆ™**ï¼š
> - **`SIGKILL` å’Œ `SIGSTOP` ä¸èƒ½è¢«å¿½ç•¥æˆ–æ•è·**ï¼
> - å…¶ä»–ä¿¡å·å¯é€šè¿‡ `signal()` æˆ– `sigaction()` è‡ªå®šä¹‰å¤„ç†ã€‚


| åŠ¨ä½œ | è¯´æ˜ | å¯¹åº”ä¿¡å·ç¤ºä¾‹ |
|------|------|-------------|
| **Term** | ç»ˆæ­¢è¿›ç¨‹ | `SIGINT`, `SIGTERM`, `SIGALRM` |
| **Core** | ç»ˆæ­¢è¿›ç¨‹ + ç”Ÿæˆ `core` è½¬å‚¨æ–‡ä»¶ï¼ˆç”¨äºè°ƒè¯•ï¼‰ | `SIGQUIT`, `SIGSEGV`, `SIGILL` |
| **Ign** | å¿½ç•¥ä¿¡å·ï¼ˆæ— æ“ä½œï¼‰ | `SIGCHLD`, `SIGURG` |
| **Stop** | æš‚åœè¿›ç¨‹ï¼ˆå¯è¢« `SIGCONT` æ¢å¤ï¼‰ | `SIGSTOP`, `SIGTSTP`, `SIGTTIN` |
| **Cont** | ç»§ç»­æ‰§è¡Œï¼ˆå·²æš‚åœçš„è¿›ç¨‹ï¼‰ | `SIGCONT` |

> ğŸ“Œ **å…³é”®è§„åˆ™**ï¼š
> - `SIGKILL` å’Œ `SIGSTOP` çš„é»˜è®¤åŠ¨ä½œ **ä¸å¯æ›´æ”¹**ï¼ˆä¸èƒ½è¢«æ•è·ã€å¿½ç•¥æˆ–é˜»å¡ï¼‰ã€‚
> - å…¶ä»–ä¿¡å·çš„é»˜è®¤åŠ¨ä½œå¯é€šè¿‡ `signal()` æˆ– `sigaction()` **è‡ªå®šä¹‰æˆ–ä¿®æ”¹**ã€‚



```c
#include <signal.h>

//handler å¯ä¸ºï¼š
//    SIG_DFLï¼šæ¢å¤é»˜è®¤è¡Œä¸º
//    SIG_IGNï¼šå¿½ç•¥ä¿¡å·
//    è‡ªå®šä¹‰å‡½æ•°æŒ‡é’ˆ
void (*signal(int sig, void (*handler)(int)))(int);
```

ç¤ºä¾‹

```c
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

void handler(int sig) {
    printf("æ”¶åˆ°ä¿¡å· %dï¼Œæ­£åœ¨é€€å‡º...\n", sig);
    exit(0);
}

int main() {
    signal(SIGINT, handler);  // æ•è· Ctrl+C
    while (1) {
        printf("è¿è¡Œä¸­...\n");
        sleep(1);
    }
}
```



### **`sigaction`**

ï¼ˆPOSIX æ ‡å‡†ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼‰

```c
#include <signal.h>
int sigaction(int signum, const struct sigaction *act, struct sigaction *oldact);
```

ç»“æ„ä½“ `struct sigaction` å®šä¹‰ï¼š

```c
struct sigaction {
    void     (*sa_handler)(int);  // å¤„ç†å‡½æ•°ï¼ˆæˆ– SIG_DFL/SIG_IGNï¼‰
    sigset_t   sa_mask;           // å¤„ç†ä¿¡å·æ—¶è¦å±è”½çš„å…¶ä»–ä¿¡å·
    int        sa_flags;          // æ ‡å¿—ï¼ˆå¦‚ SA_RESTARTï¼‰
    void  (*sa_sigaction)(int, siginfo_t *, void *); // ç”¨äºå®æ—¶ä¿¡å·
};
```

âœ… **å®‰å…¨çš„ä¿¡å·å¤„ç†ç¤ºä¾‹ï¼ˆæ¨èï¼‰**ï¼š

```c
#include <signal.h>
#include <stdio.h>
#include <unistd.h>
#include <string.h>

static volatile sig_atomic_t keep_running = 1;

void signal_handler(int sig) {
    keep_running = 0;  // åªåšæœ€ç®€æ“ä½œï¼
}

int main() {
    struct sigaction sa;
    memset(&sa, 0, sizeof(sa));
    sa.sa_handler = signal_handler;
    sigemptyset(&sa.sa_mask);
    sa.sa_flags = SA_RESTART;  // ç³»ç»Ÿè°ƒç”¨è¢«ä¸­æ–­åè‡ªåŠ¨é‡å¯

    sigaction(SIGINT, &sa, NULL);
    sigaction(SIGTERM, &sa, NULL);

    while (keep_running) {
        printf("å·¥ä½œ...\n");
        sleep(1);
    }
    printf("ç¨‹åºæ­£å¸¸é€€å‡º\n");
    return 0;
}
```

> âœ… **ä¿¡å·å¤„ç†å‡½æ•°ï¼ˆHandlerï¼‰ç¼–å†™åŸåˆ™**ï¼š
>
> 1. **åªåšæœ€ç®€æ“ä½œ**ï¼ˆå¦‚è®¾ç½® `volatile sig_atomic_t` æ ‡å¿—ï¼‰
> 2. **ä¸è¦è°ƒç”¨éå¼‚æ­¥ä¿¡å·å®‰å…¨ï¼ˆasync-signal-safeï¼‰çš„å‡½æ•°**ï¼
>    - âŒ ç¦æ­¢ï¼š`printf`, `malloc`, `exit`, `snprintf`
>    - âœ… å…è®¸ï¼š`write`, `_exit`, `signal`, `sigaction`ï¼ˆè§ `man 7 signal-safety`ï¼‰



âœ… ç¤ºä¾‹ï¼šè‡ªåŠ¨å›æ”¶åƒµå°¸è¿›ç¨‹

```c
void sigchld_handler(int sig) {
    while (waitpid(-1, NULL, WNOHANG) > 0) {
        // å›æ”¶æ‰€æœ‰å·²é€€å‡ºçš„å­è¿›ç¨‹
    }
}

int main() {
    struct sigaction sa;
    sa.sa_handler = sigchld_handler;
    sigemptyset(&sa.sa_mask);
    sa.sa_flags = SA_RESTART | SA_NOCLDSTOP;
    sigaction(SIGCHLD, &sa, NULL);

    // åˆ›å»ºå­è¿›ç¨‹...
    while (1) sleep(1);
}
```



**å®ç°å®ˆæŠ¤è¿›ç¨‹ï¼ˆDaemonï¼‰çš„ä¿¡å·æ§åˆ¶**

```c
void reload_config(int sig) {
    // é‡æ–°è¯»å–é…ç½®æ–‡ä»¶
}
signal(SIGUSR1, reload_config);

// ç®¡ç†å‘˜å¯æ‰§è¡Œï¼škill -USR1 <daemon_pid>
```

**è¶…æ—¶æ§åˆ¶ï¼ˆAlarmï¼‰**

```c
//SIGALRM å¯ç”¨äºå®ç°è¶…æ—¶ï¼š
void timeout_handler(int sig) {
    // è¶…æ—¶å¤„ç†
    _exit(1);
}
signal(SIGALRM, timeout_handler);
alarm(10);  // 10 ç§’åè§¦å‘ SIGALRM
// æ‰§è¡Œå¯èƒ½é˜»å¡çš„æ“ä½œ...
```



## å‘é€ä¿¡å·

### **`kill`**

å‘è¿›ç¨‹å‘é€ä¿¡å·

```c
#include <sys/types.h>
#include <signal.h>

// pid > 0ï¼šå‘é€ç»™æŒ‡å®š PID çš„è¿›ç¨‹
// pid == 0ï¼šå‘é€ç»™åŒè¿›ç¨‹ç»„çš„æ‰€æœ‰è¿›ç¨‹
// pid == -1ï¼šå‘é€ç»™æ‰€æœ‰æœ‰æƒé™çš„è¿›ç¨‹ï¼ˆé™¤ initï¼‰
// pid < -1ï¼šå‘é€ç»™è¿›ç¨‹ç»„ |pid|
int kill(pid_t pid, int sig);
```

ç¤ºä¾‹

```c
kill(child_pid, SIGTERM);   // ä¼˜é›…ç»ˆæ­¢å­è¿›ç¨‹
kill(getpid(), SIGINT);     // å‘è‡ªå·±å‘ Ctrl+C ä¿¡å·
```



### **`raise`**

å‘å½“å‰è¿›ç¨‹å‘ä¿¡å·

```c
int raise(int sig);  // ç­‰ä»·äº kill(getpid(), sig);
```



ä½¿ç”¨å‘½ä»¤è¡Œå‘é€ä¿¡å·

```shell
kill -9 1234        # å‘é€ SIGKILL
kill -TERM 1234     # å‘é€ SIGTERMï¼ˆé»˜è®¤ï¼‰
pkill -f "myapp"    # æŒ‰åç§°å‘ä¿¡å·
```



## ç®¡é“

### **`pipe`**

åŒ¿åç®¡é“

```c
#include <unistd.h>

//åŠŸèƒ½ï¼šåˆ›å»ºä¸€ä¸ªåŒ¿åç®¡é“ï¼Œè¿”å›ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼š
//    pipefd[0]ï¼šè¯»ç«¯ï¼ˆread endï¼‰
//    pipefd[1]ï¼šå†™ç«¯ï¼ˆwrite endï¼‰
int pipe(int pipefd[2]);
//è¿”å›å€¼ï¼š
//    æˆåŠŸï¼š0
//    å¤±è´¥ï¼š-1ï¼ˆå¦‚èµ„æºä¸è¶³ï¼‰
```

- ç®¡é“æ˜¯**å•å‘çš„**ï¼šæ•°æ®ä»å†™ç«¯æµå…¥ï¼Œä»è¯»ç«¯æµå‡ºã€‚
- å†…æ ¸æä¾›**ç¼“å†²åŒº**ï¼ˆé€šå¸¸ 64KBï¼Œå¯é€šè¿‡ `fcntl` æŸ¥è¯¢ï¼‰ã€‚
- **é€‚ç”¨äºæœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹**ï¼ˆå¦‚ `fork` åçš„çˆ¶å­è¿›ç¨‹ï¼‰ã€‚

ç¤ºä¾‹

```c
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int main() {
    int fd[2];
    pipe(fd);  // åˆ›å»ºç®¡é“

    pid_t pid = fork();
    if (pid == 0) {
        // å­è¿›ç¨‹ï¼šè¯»å–
        close(fd[1]); // å…³é—­å†™ç«¯
        char buf[100];
        read(fd[0], buf, sizeof(buf));
        printf("å­è¿›ç¨‹æ”¶åˆ°: %s\n", buf);
        close(fd[0]);
    } else {
        // çˆ¶è¿›ç¨‹ï¼šå†™å…¥
        close(fd[0]); // å…³é—­è¯»ç«¯
        const char *msg = "Hello from parent";
        write(fd[1], msg, strlen(msg) + 1);
        close(fd[1]);
        wait(NULL); // ç­‰å¾…å­è¿›ç¨‹
    }
    return 0;
}
```

âš ï¸ **æ³¨æ„äº‹é¡¹**

- **å¿…é¡»å…³é—­ä¸ç”¨çš„ç«¯**ï¼šå¦åˆ™è¯»ç«¯æ— æ³•æ”¶åˆ° EOFï¼ˆåªæœ‰æ‰€æœ‰å†™ç«¯å…³é—­ï¼Œè¯»æ‰ä¼šè¿”å› 0ï¼‰ã€‚
- **å†™æ»¡ä¼šé˜»å¡**ï¼šå½“ç®¡é“ç¼“å†²åŒºæ»¡æ—¶ï¼Œ`write` ä¼šé˜»å¡ï¼ˆé™¤éè®¾ä¸ºéé˜»å¡ï¼‰ã€‚
- **è¯»ç©ºä¼šé˜»å¡**ï¼šå½“ç®¡é“æ— æ•°æ®æ—¶ï¼Œ`read` ä¼šé˜»å¡ã€‚



### **`mkfifo`**

å‘½åç®¡é“ï¼Œ**å‘½åç®¡é“**å¯é€šè¿‡**æ–‡ä»¶ç³»ç»Ÿè·¯å¾„å**è¢«**ä»»æ„è¿›ç¨‹**è®¿é—®

```c
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

//åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªç‰¹æ®Šæ–‡ä»¶ï¼ˆç±»å‹ä¸º pï¼‰ï¼Œå³ FIFOã€‚
int mkfifo(const char *pathname, mode_t mode);
//è¿”å›å€¼ï¼š
//    æˆåŠŸï¼š0
//    å¤±è´¥ï¼š-1ï¼ˆå¦‚æ–‡ä»¶å·²å­˜åœ¨ã€æƒé™ä¸è¶³ç­‰ï¼‰
```

ç¤ºä¾‹

```c
// å†™è¿›ç¨‹
int fd = open("mypipe", O_WRONLY); // é˜»å¡ç›´åˆ°æœ‰è¯»è¿›ç¨‹æ‰“å¼€
write(fd, "data", 4);
close(fd);

// è¯»è¿›ç¨‹
int fd = open("mypipe", O_RDONLY); // é˜»å¡ç›´åˆ°æœ‰å†™è¿›ç¨‹æ‰“å¼€
read(fd, buf, size);
close(fd);
```



### **`pipe2`**

é«˜çº§ç®¡é“ï¼ˆå¸¦æ ‡å¿—ï¼‰ï¼ˆæ¨èï¼‰

```c
#include <unistd.h>

//åŠŸèƒ½ï¼špipe() çš„å¢å¼ºç‰ˆï¼Œæ”¯æŒåœ¨åˆ›å»ºæ—¶è®¾ç½®æ ‡å¿—ã€‚
//å¸¸ç”¨æ ‡å¿—ï¼š
//    O_CLOEXECï¼šæ‰§è¡Œ exec æ—¶è‡ªåŠ¨å…³é—­ç®¡é“ï¼ˆé¿å…å­è¿›ç¨‹ç»§æ‰¿ï¼‰
//    O_NONBLOCKï¼šç®¡é“ä¸ºéé˜»å¡æ¨¡å¼
int pipe2(int pipefd[2], int flags);
```

ç¤ºä¾‹

```c
pipe2(fd, O_CLOEXEC | O_NONBLOCK);
```



## è·å–æ—¶é—´

**ç§’çº§ç²¾åº¦**

### **`time`**

è·å–å½“å‰æ—¥å†æ—¶é—´

```c
#include <time.h>

//è¿”å›è‡ª Unix çºªå…ƒï¼ˆ1970-01-01 00:00:00 UTCï¼‰ ä»¥æ¥çš„ç§’æ•°ã€‚
time_t time(time_t *tloc);
//æˆåŠŸè¿”å›ç§’æ•°ï¼Œå¤±è´¥è¿”å› (time_t)-1ã€‚
//å‚æ•°ï¼šè‹¥ tloc é NULLï¼Œç»“æœä¹Ÿå­˜å…¥ *tlocã€‚
```

ç¤ºä¾‹

```c
time_t now = time(NULL);
printf("å½“å‰æ—¶é—´ï¼ˆç§’ï¼‰: %ld\n", now);
```



### **`localtime`**

å°†`time_t`è½¬ä¸ºç»“æ„åŒ–æœ¬åœ°æ—¶é—´

### **`gmtime`**

 å°† `time_t` è½¬ä¸ºç»“æ„åŒ–UTCæ—¶é—´

```c

struct tm *localtime(const time_t *timep);   // è½¬æœ¬åœ°æ—¶é—´

struct tm *gmtime(const time_t *timep);      // è½¬ UTC æ—¶é—´
```

ç»“æ„ä½“

```c
struct tm {
    int tm_sec;   // ç§’ (0-60)
    int tm_min;   // åˆ† (0-59)
    int tm_hour;  // å°æ—¶ (0-23)
    int tm_mday;  // æœˆä»½ä¸­çš„æ—¥ (1-31)
    int tm_mon;   // æœˆ (0-11, 0=Jan)
    int tm_year;  // å¹´ (è‡ª1900èµ·)
    int tm_wday;  // æ˜ŸæœŸ (0=Sun, 6=Sat)
    int tm_yday;  // å¹´ä¸­çš„æ—¥ (0-365)
    int tm_isdst; // å¤ä»¤æ—¶æ ‡å¿—
};
```



### **`mktime`**

å°†ç»“æ„ä½“è½¬å›`time_t`

- **ç”¨é€”**ï¼šå°†æœ¬åœ°æ—¶é—´ç»“æ„è½¬æ¢ä¸º `time_t`ï¼ˆè€ƒè™‘æ—¶åŒºå’Œå¤ä»¤æ—¶ï¼‰ã€‚
- **å‰¯ä½œç”¨**ï¼šä¼š**è§„èŒƒåŒ–** `tm` å­—æ®µï¼ˆå¦‚ `tm_mon = 12` ä¼šè‡ªåŠ¨è¿›ä½åˆ°ä¸‹ä¸€å¹´ï¼‰ã€‚

ç¤ºä¾‹

```c
struct tm t = {0};
t.tm_year = 2025 - 1900;
t.tm_mon = 11;   // 12æœˆï¼ˆ0-basedï¼‰
t.tm_mday = 1;
time_t dec1 = mktime(&t);
```



### **`strftime`**

å°† `struct tm` ç»“æ„ä½“è½¬ä¸ºå­—ç¬¦ä¸²

```c
//æŒ‰ format æ ¼å¼åŒ–æ—¶é—´åˆ°å­—ç¬¦ä¸² sã€‚
size_t strftime(char *s, size_t max, const char *format, const struct tm *tm);
//ä¸ä¼šæº¢å‡ºï¼ˆæœ€å¤šå†™ max-1 å­—ç¬¦ + \0ï¼‰ã€‚
```

âœ… å¸¸ç”¨æ ¼å¼è¯´æ˜ç¬¦ï¼š
| è¯´æ˜ç¬¦ | å«ä¹‰ | ç¤ºä¾‹ |
|--------|------|------|
| `%Y` | 4ä½å¹´ | 2025 |
| `%m` | æœˆï¼ˆ01-12ï¼‰ | 12 |
| `%d` | æ—¥ï¼ˆ01-31ï¼‰ | 01 |
| `%H` | å°æ—¶ï¼ˆ00-23ï¼‰ | 15 |
| `%M` | åˆ†ï¼ˆ00-59ï¼‰ | 30 |
| `%S` | ç§’ï¼ˆ00-61ï¼‰ | 45 |
| `%F` | ç­‰ä»·äº `%Y-%m-%d` | 2025-12-01 |
| `%T` | ç­‰ä»·äº `%H:%M:%S` | 15:30:45 |

âœ… ç¤ºä¾‹ï¼š
```c
time_t now = time(NULL);
struct tm *lt = localtime(&now);
char buf[64];
strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", lt);
printf("å½“å‰æ—¶é—´: %s\n", buf);
```



### **`strptime`**

`strftime`çš„åæ“ä½œï¼Œå°†å­—ç¬¦ä¸²è½¬ä¸ºç»“æ„ä½“

```c
#define _XOPEN_SOURCE
#include <time.h>

// åŠŸèƒ½ï¼šstrftime çš„åå‘æ“ä½œï¼ˆè§£æå­—ç¬¦ä¸²ä¸º struct tmï¼‰ã€‚
// æ³¨æ„ï¼šé C æ ‡å‡†ï¼Œéœ€å®šä¹‰ _XOPEN_SOURCEï¼ŒWindows ä¸æ”¯æŒã€‚
char *strptime(const char *s, const char *format, struct tm *tm);
```

ç¤ºä¾‹

```c
struct tm t = {0};
strptime("2025-12-01 15:30:00", "%Y-%m-%d %H:%M:%S", &t);
time_t ts = mktime(&t);
```



**é«˜ç²¾åº¦**

### **`gettimeofday`**

å¾®ç§’çº§æ—¶é—´ï¼ˆPOSIXï¼‰ï¼ˆå·²è¢«æ ‡è®°è¿‡æ—¶å‡½æ•°ï¼‰

```c
#include <sys/time.h>
int gettimeofday(struct timeval *tv, struct timezone *tz);

//ç»“æ„ä½“å±•å¼€
struct timeval {
    time_t      tv_sec;  // ç§’
    suseconds_t tv_usec; // å¾®ç§’ (0-999999)
};
```

ç¤ºä¾‹

```c
struct timeval tv;
gettimeofday(&tv, NULL);
printf("å¾®ç§’æ—¶é—´: %ld.%06ld\n", tv.tv_sec, tv.tv_usec);
```



### **`clock_gettime`**

çº³ç§’çº§æ—¶é—´ï¼ˆPOSIX.1bï¼‰

```c
#include <time.h>
int clock_gettime(clockid_t clk_id, struct timespec *tp);

//ç»“æ„ä½“å±•å¼€
struct timespec {
    time_t tv_sec;  // ç§’
    long   tv_nsec; // çº³ç§’ (0-999999999)
};
```

**å¸¸ç”¨æ—¶é’Ÿ ID**ï¼š

- `CLOCK_REALTIME`ï¼šç³»ç»Ÿå®æ—¶æ—¶é—´ï¼ˆå¯è¢« `settimeofday` ä¿®æ”¹ï¼‰
- `CLOCK_MONOTONIC`ï¼šå•è°ƒæ—¶é—´ï¼ˆè‡ªç³»ç»Ÿå¯åŠ¨èµ·ï¼Œ**ä¸å—ç³»ç»Ÿæ—¶é—´è°ƒæ•´å½±å“**ï¼Œé€‚åˆè®¡ç®—é—´éš”ï¼‰
- `CLOCK_PROCESS_CPUTIME_ID`ï¼šå½“å‰è¿›ç¨‹ CPU æ—¶é—´
- `CLOCK_THREAD_CPUTIME_ID`ï¼šå½“å‰çº¿ç¨‹ CPU æ—¶é—´

ç¤ºä¾‹ï¼šè®¡ç®—ä»£ç æ‰§è¡Œæ—¶é—´

```c
struct timespec start, end;
clock_gettime(CLOCK_MONOTONIC, &start);
// ... æ‰§è¡Œæ“ä½œ ...
clock_gettime(CLOCK_MONOTONIC, &end);

double elapsed = (end.tv_sec - start.tv_sec) +
                 (end.tv_nsec - start.tv_nsec) / 1e9;
printf("è€—æ—¶: %.6f ç§’\n", elapsed);
```

> ğŸ”‘ **å…³é”®åŒºåˆ«**ï¼š
>
> - `CLOCK_REALTIME`ï¼šé€‚åˆè·å–â€œæ—¥å†æ—¶é—´â€ã€‚
> - `CLOCK_MONOTONIC`ï¼š**é€‚åˆæµ‹é‡æ—¶é—´é—´éš”**ï¼ˆä¸å— NTP è°ƒæ•´ã€æ—¶åŒºå˜æ›´å½±å“ï¼‰ã€‚



**çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬ï¼ˆæ¨èä½¿ç”¨ï¼‰**

æ ‡å‡†å‡½æ•° `localtime`/`gmtime` è¿”å›**å…¨å±€é™æ€æŒ‡é’ˆ**ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¸å®‰å…¨ã€‚åº”ä½¿ç”¨ `_r`ï¼ˆreentrantï¼‰ç‰ˆæœ¬

### **`localtime_r`**

```c
struct tm *localtime_r(const time_t *timep, struct tm *result);
```



### **`gmtime_r`**

```c
struct tm *gmtime_r(const time_t *timep, struct tm *result);
```

ç¤ºä¾‹

```c
time_t now = time(NULL);
struct tm lt;
localtime_r(&now, &lt); // ç»“æœå­˜å…¥ ltï¼Œçº¿ç¨‹å®‰å…¨
```



### **`difftime`**

```c
double difftime(time_t time1, time_t time0);
//è¿”å›ï¼štime1 - time0 çš„ç§’æ•°ï¼ˆdouble ç±»å‹ï¼Œå¯è¡¨ç¤ºå°æ•°ç§’ï¼‰ã€‚
```

ç¤ºä¾‹

```c
time_t start = time(NULL);
sleep(2);
time_t end = time(NULL);
printf("ç»è¿‡ %.0f ç§’\n", difftime(end, start));
```

é«˜ç²¾åº¦è®¡ç®—

```c
// timespec å·®å€¼
double timespec_diff(struct timespec *a, struct timespec *b) {
    return (a->tv_sec - b->tv_sec) + (a->tv_nsec - b->tv_nsec) / 1e9;
}
```



### **`sleep`**

ç§’çº§ä¼‘çœ 

```c
unsigned int sleep(unsigned int seconds);
//è¿”å›ï¼šæœªä¼‘çœ çš„ç§’æ•°ï¼ˆè‹¥è¢«ä¿¡å·ä¸­æ–­ï¼‰ã€‚
```



### **`usleep`**

å¾®ç§’çº§ä¼‘çœ ï¼ˆå·²åºŸå¼ƒï¼‰

```c
int usleep(useconds_t usec); // æœ€å¤§ 999999 å¾®ç§’
//æ›¿ä»£æ–¹æ¡ˆï¼šä½¿ç”¨ nanosleep()ï¼ˆæ”¯æŒçº³ç§’ï¼Œå¯è¢«ä¿¡å·ä¸­æ–­åé‡å¯ï¼‰
```



### **`nanosleep()`**

çº³ç§’çº§ä¼‘çœ ï¼ˆæ¨èï¼‰

```c
#include <time.h>

int nanosleep(const struct timespec *req, struct timespec *rem);
// reqï¼šè¯·æ±‚ä¼‘çœ æ—¶é—´
// remï¼šè‹¥è¢«ä¿¡å·ä¸­æ–­ï¼Œå‰©ä½™æ—¶é—´å­˜å…¥ rem
```

ç¤ºä¾‹

```c
struct timespec ts = {0, 500000000}; // 0.5 ç§’
nanosleep(&ts, NULL);
```

**æœ€ä½³å®è·µå»ºè®®**

1. **æµ‹é‡æ—¶é—´é—´éš”ç”¨ `CLOCK_MONOTONIC`**ï¼Œé¿å…ç³»ç»Ÿæ—¶é—´è·³å˜å½±å“ã€‚
2. **é¿å…ä½¿ç”¨ `gettimeofday` å’Œ `usleep`**ï¼ˆå·²è¿‡æ—¶ï¼‰ã€‚
3. **å¤šçº¿ç¨‹ç¨‹åºä½¿ç”¨ `_r` ç‰ˆæœ¬å‡½æ•°**ï¼ˆå¦‚ `localtime_r`ï¼‰ã€‚
4. **ä¸è¦ä¾èµ– `time_t` æ˜¯ 32 ä½**ï¼ˆ2038 å¹´é—®é¢˜ï¼‰ï¼Œç°ä»£ç³»ç»Ÿå¤šä¸º 64 ä½ã€‚
5. **æ ¼å¼åŒ–/è§£ææ—¶é—´ä¼˜å…ˆç”¨ `strftime`/`strptime`**ï¼Œé¿å…æ‰‹åŠ¨æ‹¼æ¥ã€‚



## çº¿ç¨‹ç›¸å…³å‡½æ•°

### **`pthread_create`**

NPTL (Native POSIX Threads Library) å‡½æ•°åº“

åˆ›å»ºæ–°çº¿ç¨‹

```c
#include <pthread.h>

//threadï¼šè¾“å‡ºå‚æ•°ï¼Œç”¨äºå­˜å‚¨æ–°çº¿ç¨‹ IDã€‚
//attrï¼šçº¿ç¨‹å±æ€§ï¼ˆNULL è¡¨ç¤ºé»˜è®¤ï¼‰ã€‚
//start_routineï¼šçº¿ç¨‹å…¥å£å‡½æ•°ï¼ˆå¿…é¡»è¿”å› void*ï¼‰ã€‚
//argï¼šä¼ é€’ç»™å…¥å£å‡½æ•°çš„å‚æ•°ã€‚
int pthread_create(pthread_t *thread,
                   const pthread_attr_t *attr,
                   void *(*start_routine)(void *),
                   void *arg);
//è¿”å›å€¼ï¼š0 æˆåŠŸï¼Œé 0 ä¸ºé”™è¯¯ç ï¼ˆä¸æ˜¯ errnoï¼‰ã€‚
```



### **`pthread_join`**

å›æ”¶çº¿ç¨‹èµ„æº

é˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œç›´åˆ° thread ç»ˆæ­¢ã€‚

```c
// ä½œç”¨ï¼š
//   å›æ”¶çº¿ç¨‹èµ„æºï¼ˆç±»ä¼¼ wait å¯¹è¿›ç¨‹çš„ä½œç”¨ï¼‰
//   retvalè·å–çº¿ç¨‹è¿”å›å€¼
//   åªèƒ½å¯¹ å¯è¿æ¥ï¼ˆjoinableï¼‰ çº¿ç¨‹è°ƒç”¨ï¼ˆé»˜è®¤å°±æ˜¯ï¼‰ã€‚
int pthread_join(pthread_t thread, void **retval);
//å…³é”®ï¼šé¿å…â€œåƒµå°¸çº¿ç¨‹â€ï¼ˆç±»ä¼¼åƒµå°¸è¿›ç¨‹ï¼‰ã€‚
```

ç¤ºä¾‹

```c
int main(int argc, char **argv)
{
	pthread_t tid1;
	int *pa = NULL;
	pthread_create(&tid1, NULL, thread_fun1, NULL); //è°ƒç”¨ç«‹å³è¿”å›
	pthread_join(tid1, (void **)&pa);
	printf("return value: %d\n", *pa);
	free(pa);
	printf("main thread exit\n");
	return 0;
}
```





### **`pthread_detach`**

å°†çº¿ç¨‹æ ‡è®°ä¸ºåˆ†ç¦»çŠ¶æ€ï¼ˆdetachedï¼‰

```c
//ç‰¹ç‚¹ï¼š
//   çº¿ç¨‹ç»“æŸåè‡ªåŠ¨é‡Šæ”¾èµ„æºï¼Œæ— éœ€ pthread_join
//   ä¸èƒ½å¯¹åˆ†ç¦»çº¿ç¨‹è°ƒç”¨ pthread_join
//é€‚ç”¨åœºæ™¯ï¼šä¸éœ€è¦è·å–è¿”å›å€¼çš„åå°çº¿ç¨‹ã€‚
int pthread_detach(pthread_t thread);
```

ç¤ºä¾‹

```c
pthread_t tid;
pthread_create(&tid, NULL, thread_func, NULL);
pthread_detach(tid); // è‡ªåŠ¨æ¸…ç†
```



### **`pthread_exit`**

ç»ˆæ­¢å½“å‰çº¿ç¨‹

```c
//ç»ˆæ­¢è°ƒç”¨çº¿ç¨‹ï¼Œretval å¯è¢« pthread_join è·å–ã€‚
//ä¸ return çš„åŒºåˆ«ï¼š
//    return ä»…é€€å‡ºå‡½æ•°ï¼Œpthread_exit ç«‹å³ç»ˆæ­¢æ•´ä¸ªçº¿ç¨‹ã€‚
//    åœ¨ main ä¸­è°ƒç”¨ pthread_exit ä¼šç»ˆæ­¢æ•´ä¸ªè¿›ç¨‹ï¼ˆæ‰€æœ‰çº¿ç¨‹ï¼‰ã€‚
void pthread_exit(void *retval);
```

ç¤ºä¾‹

```c
void *thread_func(void *arg) {
    if (error) {
        pthread_exit(NULL); // æå‰é€€å‡º
    }
    return NULL;
}
```



### **`pthread_self`**

è·å–å½“å‰çº¿ç¨‹ID

```c
// ç”¨äºçº¿ç¨‹å†…éƒ¨è¯†åˆ«è‡ªå·±ã€‚
// æ³¨æ„ï¼špthread_t ä¸ä¸€å®šæ˜¯æ•´æ•°ï¼ˆå¯èƒ½æ˜¯ç»“æ„ä½“ï¼‰ï¼Œä¸èƒ½ç›´æ¥æ¯”è¾ƒæˆ–æ‰“å°ï¼
// æ¯”è¾ƒçº¿ç¨‹ ID åº”ä½¿ç”¨ pthread_equal()ï¼š
pthread_t pthread_self(void);
```

ç¤ºä¾‹

```c
if (pthread_equal(pthread_self(), main_thread_id)) {
    // æ˜¯ä¸»çº¿ç¨‹
}
```



### **`pthread_cancel`**

**å–æ¶ˆçº¿ç¨‹**

```c
// ä¸ç«‹å³ç»ˆæ­¢ï¼çº¿ç¨‹éœ€åˆ°è¾¾å–æ¶ˆç‚¹ï¼ˆcancellation pointï¼‰ æ‰å“åº”ã€‚
// å¸¸è§å–æ¶ˆç‚¹ï¼šsleep, read, write, pthread_testcancel() ç­‰ã€‚
int pthread_cancel(pthread_t thread);
```

æ§åˆ¶å–æ¶ˆè¡Œä¸º

```c
// ç¦ç”¨å–æ¶ˆ
pthread_setcancelstate(PTHREAD_CANCEL_DISABLE, NULL);
// å¯ç”¨å–æ¶ˆ
pthread_setcancelstate(PTHREAD_CANCEL_ENABLE, NULL);
// è®¾ç½®å–æ¶ˆç±»å‹
pthread_setcanceltype(PTHREAD_CANCEL_DEFERRED, NULL);  // å»¶è¿Ÿï¼ˆé»˜è®¤ï¼‰
pthread_setcanceltype(PTHREAD_CANCEL_ASYNCHRONOUS, NULL); // å¼‚æ­¥ï¼ˆå±é™©ï¼ï¼‰
// è­¦å‘Šï¼šå¼‚æ­¥å–æ¶ˆå¯èƒ½å¯¼è‡´èµ„æºæ³„æ¼ï¼ˆå¦‚æœªé‡Šæ”¾é”ï¼‰ï¼Œé¿å…ä½¿ç”¨ã€‚
```

ç¤ºä¾‹

```c
#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <unistd.h>

void *thread_fun1(void *arg)
{
	pthread_detach(pthread_self()); //çº¿ç¨‹åˆ†ç¦»
	for (;;) {
		printf("this is sub thread1 %ld   %d  \n", pthread_self(), i);
		sleep(1);
	}
	pthread_exit(NULL);
}
int main(int argc, char **argv)
{
	pthread_t tid1;
	int a = 100;
	pthread_create(&tid1, NULL, thread_fun1, &a); 
	for (int i = 0; i < 5; i++) {
		printf("this is main thread %ld   %d  \n", pthread_self(), i);
		sleep(1);
		if (i==2) pthread_cancel(tid1);
	}
	printf("main thread exit\n");
	return 0;
}
```



### **`pthread_once`**

ä¸€æ¬¡æ€§åˆå§‹åŒ–

```c
// ç”¨é€”ï¼šçº¿ç¨‹å®‰å…¨çš„æ‡’åˆå§‹åŒ–ï¼ˆå¦‚å•ä¾‹æ¨¡å¼ï¼‰ã€‚
pthread_once_t once = PTHREAD_ONCE_INIT;
void init_func(void) { /* åˆå§‹åŒ–ä»£ç  */ }

void thread_func(void) {
    pthread_once(&once, init_func); // ä¿è¯åªæ‰§è¡Œä¸€æ¬¡
}
```



## ä¿¡å·é‡

åˆ†ç±»

- sem_open()ï¼šå‘½åä¿¡å·é‡ï¼Œå¯è·¨**æ— å…³è¿›ç¨‹**å…±äº«
- sem_init()ï¼šåŒ¿åä¿¡å·é‡ï¼Œä»…ç”¨äº**çº¿ç¨‹é—´**æˆ–**ç›¸å…³è¿›ç¨‹ï¼ˆå¦‚çˆ¶å­è¿›ç¨‹ï¼‰**



### **`sem_init`**

**åŒ¿åä¿¡å·**åˆå§‹åŒ–

```c
#include <semaphore.h>
// semï¼šæŒ‡å‘ä¿¡å·é‡å˜é‡çš„æŒ‡é’ˆã€‚
// psharedï¼š
//     0ï¼šçº¿ç¨‹é—´å…±äº«ï¼ˆä¿¡å·é‡ä½äºè¿›ç¨‹å†…å­˜ä¸­ï¼‰
//     é 0ï¼šè¿›ç¨‹é—´å…±äº«ï¼ˆéœ€æ”¾åœ¨å…±äº«å†…å­˜ä¸­ï¼Œå¦‚ mmap æˆ–å…¨å±€å˜é‡ï¼‰
// valueï¼šä¿¡å·é‡åˆå§‹å€¼ï¼ˆå¯ç”¨èµ„æºæ•°é‡ï¼‰ã€‚
int sem_init(sem_t *sem, int pshared, unsigned int value);
// 0 æˆåŠŸï¼Œ-1 å¤±è´¥ã€‚
```

çº¿ç¨‹é—´ä½¿ç”¨ç¤ºä¾‹

```c
#include <semaphore.h>
#include <pthread.h>
#include <stdio.h>

sem_t sem;

void *producer(void *arg) {
    for (int i = 0; i < 5; i++) {
        sleep(1);
        printf("ç”Ÿäº§ç‰©å“ %d\n", i);
        sem_post(&sem); // V æ“ä½œï¼šé‡Šæ”¾èµ„æº
    }
    return NULL;
}
void *consumer(void *arg) {
    for (int i = 0; i < 5; i++) {
        sem_wait(&sem); // P æ“ä½œï¼šè·å–èµ„æºï¼ˆè‹¥ value=0 åˆ™é˜»å¡ï¼‰
        printf("æ¶ˆè´¹ç‰©å“ %d\n", i);
    }
    return NULL;
}
int main() {
    sem_init(&sem, 0, 0); // çº¿ç¨‹é—´ï¼Œåˆå§‹å€¼=0
    pthread_t p, c;
    pthread_create(&p, NULL, producer, NULL);
    pthread_create(&c, NULL, consumer, NULL);
    
    pthread_join(p, NULL);
    pthread_join(c, NULL);
    
    sem_destroy(&sem);
    return 0;
}
```

é”€æ¯

```c
// é‡Šæ”¾ä¿¡å·é‡èµ„æºï¼ˆä»…å¯¹ sem_init åˆ›å»ºçš„ä¿¡å·é‡æœ‰æ•ˆï¼‰ã€‚
int sem_destroy(sem_t *sem);
```



### **`sem_open`**

**å‘½åä¿¡å·**åˆå§‹åŒ–

```c
// nameï¼šä¿¡å·é‡åç§°ï¼ˆå¿…é¡»ä»¥ / å¼€å¤´ï¼Œå¦‚ "/mysem"ï¼Œä¸”ä¸èƒ½åŒ…å«å…¶ä»– /ï¼‰ã€‚
// oflagï¼š
//    O_CREATï¼šè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»º
//    O_EXCLï¼šä¸ O_CREAT åŒç”¨ï¼Œè‹¥å·²å­˜åœ¨åˆ™å¤±è´¥
// modeï¼šæƒé™ï¼ˆå¦‚ 0644ï¼‰
// valueï¼šåˆå§‹å€¼ï¼ˆä»…åœ¨åˆ›å»ºæ—¶éœ€è¦ï¼‰
sem_t *sem_open(const char *name, int oflag, ... /* mode_t mode, unsigned int value */);
```

è¿›ç¨‹é—´ä½¿ç”¨ç¤ºä¾‹

Aï¼ˆåˆ›å»ºè€…ï¼‰

```c
// producer.c
#include <semaphore.h>
#include <fcntl.h>
#include <stdio.h>

int main() {
    sem_t *sem = sem_open("/mysem", O_CREAT, 0644, 0);
    if (sem == SEM_FAILED) {
        perror("sem_open");
        return 1;
    }

    printf("ç”Ÿäº§ç‰©å“\n");
    sem_post(sem); // é‡Šæ”¾èµ„æº

    sleep(5); // ç­‰å¾…æ¶ˆè´¹è€…
    sem_close(sem);
    sem_unlink("/mysem"); // åˆ é™¤ä¿¡å·é‡ï¼ˆç±»ä¼¼ unlink æ–‡ä»¶ï¼‰
    return 0;
}
```

Bï¼ˆä½¿ç”¨è€…ï¼‰

```c
#include <semaphore.h>
#include <stdio.h>

int main() {
    sem_t *sem = sem_open("/mysem", 0); // æ‰“å¼€å·²å­˜åœ¨çš„ä¿¡å·é‡
    if (sem == SEM_FAILED) {
        perror("sem_open");
        return 1;
    }

    sem_wait(sem); // ç­‰å¾…èµ„æº
    printf("æ¶ˆè´¹ç‰©å“\n");

    sem_close(sem);
    return 0;
}
```



### **`sem_wait`**

P æ“ä½œï¼ˆè·å–èµ„æºï¼‰

```c
// è‹¥ä¿¡å·é‡å€¼ > 0ï¼šåŸå­å‡ 1ï¼Œç«‹å³è¿”å›ã€‚
// è‹¥ä¿¡å·é‡å€¼ = 0ï¼šé˜»å¡ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹/è¿›ç¨‹è°ƒç”¨ sem_postã€‚
int sem_wait(sem_t *sem);
```



### **`sem_trywait`**

éé˜»å¡ P æ“ä½œ

```c
// è‹¥ä¿¡å·é‡ä¸º 0ï¼Œç«‹å³è¿”å› -1ï¼Œå¹¶è®¾ç½® errno = EAGAINã€‚
int sem_trywait(sem_t *sem);
```



### **`sem_timedwait`**

å¸¦è¶…æ—¶çš„ P æ“ä½œ

```c
// abs_timeout æ˜¯ç»å¯¹æ—¶é—´ï¼ˆè‡ª Unix çºªå…ƒèµ·ï¼‰ã€‚
// è¶…æ—¶è¿”å› -1ï¼Œerrno = ETIMEDOUTã€‚
int sem_timedwait(sem_t *sem, const struct timespec *abs_timeout);
```

ç¤ºä¾‹

```c
struct timespec ts;
clock_gettime(CLOCK_REALTIME, &ts);
ts.tv_sec += 5; // 5ç§’è¶…æ—¶
if (sem_timedwait(&sem, &ts) == -1) {
    if (errno == ETIMEDOUT) {
        printf("ç­‰å¾…è¶…æ—¶\n");
    }
}
```



### **`sem_post`**

V æ“ä½œï¼ˆé‡Šæ”¾èµ„æºï¼‰

```c
// åŸå­åŠ  1ã€‚
// è‹¥æœ‰çº¿ç¨‹/è¿›ç¨‹åœ¨ sem_wait ä¸­é˜»å¡ï¼Œå”¤é†’å…¶ä¸­ä¸€ä¸ªã€‚
int sem_post(sem_t *sem);
```



### **`sem_getvalue`**

æŸ¥è¯¢ä¿¡å·é‡å½“å‰å€¼

```c
// å°†å½“å‰ä¿¡å·é‡å€¼å­˜å…¥ *svalã€‚
// æ³¨æ„ï¼šå€¼å¯èƒ½åœ¨è¿”å›åç«‹å³æ”¹å˜ï¼Œä»…ç”¨äºè°ƒè¯•æˆ–ç›‘æ§ï¼Œä¸èƒ½ç”¨äºåŒæ­¥é€»è¾‘ï¼
int sem_getvalue(sem_t *sem, int *sval);
```



### **`sem_close`**

å…³é—­å‘½åä¿¡å·é‡ï¼ˆå‡å°‘å¼•ç”¨è®¡æ•°ï¼‰

```c
sem_close(sem_t *sem);
```



### **`sem_unlink`**

ä»ç³»ç»Ÿä¸­åˆ é™¤å‘½åä¿¡å·é‡ï¼ˆå½“æ‰€æœ‰è¿›ç¨‹å…³é—­åé”€æ¯ï¼‰

```c
sem_unlink(const char *name);
```

> âš ï¸ **é‡è¦**ï¼š
>
> - **åŒ¿åä¿¡å·é‡**ï¼šç”¨ `sem_destroy()`
> - **å‘½åä¿¡å·é‡**ï¼šç”¨ `sem_close()` + `sem_unlink()`



æ³¨æ„ï¼šä½¿ç”¨ POSIX ä¿¡å·é‡éœ€é“¾æ¥å®æ—¶åº“ï¼ˆæŸäº›ç³»ç»Ÿï¼‰

```makefile
gcc -pthread -lrt program.c -o program
```

- `-pthread`ï¼šå¯ç”¨çº¿ç¨‹æ”¯æŒï¼ˆå³ä½¿åªç”¨è¿›ç¨‹é—´ä¿¡å·é‡ï¼ŒæŸäº›ç³»ç»Ÿä¹Ÿéœ€è¦ï¼‰
- `-lrt`ï¼šåœ¨æ—§ç‰ˆ glibc ä¸­å¯èƒ½éœ€è¦ï¼ˆæ–°ç‰ˆé€šå¸¸ä¸éœ€è¦ï¼‰



## äº’æ–¥é”



**é™æ€åˆå§‹åŒ–**

```c
#include <pthread.h>

// å…¨å±€äº’æ–¥é”
pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;
```

âœ… ä¼˜ç‚¹ï¼šç®€å•ã€æ— éœ€æ˜¾å¼åˆå§‹åŒ–/é”€æ¯ã€‚
âš ï¸ é™åˆ¶ï¼šåªèƒ½ç”¨äº**é™æ€å­˜å‚¨æœŸ**çš„å˜é‡ï¼ˆå…¨å±€æˆ– `static`ï¼‰ã€‚



**åŠ¨æ€åˆå§‹åŒ–**

```c
pthread_mutex_t mutex;

// åˆå§‹åŒ–
// ç¬¬äºŒä¸ªå‚æ•° attrï¼šæŒ‡å‘ pthread_mutexattr_t çš„æŒ‡é’ˆï¼ŒNULL è¡¨ç¤ºä½¿ç”¨é»˜è®¤å±æ€§ã€‚
if (pthread_mutex_init(&mutex, NULL) != 0) {
    perror("mutex init failed");
    return -1;
}

// ä½¿ç”¨...
pthread_mutex_lock(&mutex);
// ä¸´ç•ŒåŒº
pthread_mutex_unlock(&mutex);

// é”€æ¯
pthread_mutex_destroy(&mutex);
```

