# GCCå¸¸ç”¨æŒ‡ä»¤

## ðŸš€åŸºç¡€ç¼–è¯‘é€‰é¡¹

***

* **`-Wall`** : åˆ†æˆä¸¤éƒ¨åˆ†`-W`+`all`, æ£€æµ‹ç¨‹åºä¸­å„ç§é—®é¢˜

```bash
$ gcc -Wall hello.c -o hello
```

![æˆªå›¾](pic/001.png)

> ä¸éœ€è¦ç¼–è¯‘`.h`æ–‡ä»¶ï¼Œå› ä¸º`.h`æ–‡ä»¶åœ¨`.c`æ–‡ä»¶é‡Œæ˜¾å¼åŒ…å«äº†ï¼Œä»£ç æ£€æŸ¥æ—¶ä¼šè‡ªåŠ¨å¼•å…¥ç¼–è¯‘

***

* **`-v`** : æ˜¾ç¤ºç¼–è¯‘è¿‡ç¨‹ä¿¡æ¯

```bash
$ gcc -Wall -v hello.c main.c -o test
```

![æˆªå›¾](pic/002.png)

***

* **`-c`** : æ‰§è¡Œâ€˜é¢„å¤„ç†â€™â€˜æ±‡ç¼–â€™â€˜ç¼–è¯‘â€™æ­¥éª¤ï¼Œç”Ÿæˆ`.o`æ–‡ä»¶

```bash
$ gcc -Wall -c main.c hello.c
```

![æˆªå›¾](pic/003.png)

> æ— éœ€æ·»åŠ `-o`é€‰é¡¹ï¼Œ`-o`ä¼šè°ƒç”¨é“¾æŽ¥å™¨ç”Ÿæˆç›®æ ‡å¯æ‰§è¡Œæ–‡ä»¶

```bash
$ gcc main.o hello.o -o test
```

> è¿™é‡Œæ— éœ€`-Wall`ï¼Œå› ä¸º`-Wall`æ˜¯æ£€æŸ¥ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é—®é¢˜ï¼Œè¿™é‡Œåªæ‰§è¡Œäº†é“¾æŽ¥æ“ä½œ

### â—ç¼–è¯‘æ¬¡åºé—®é¢˜

> ä¸»è¦é’ˆå¯¹ä¸€äº›æ¯”è¾ƒè€çš„ç¼–è¾‘å™¨

  + gccæ£€æµ‹æ–‡ä»¶æ˜¯ä»Žå³å¾€å·¦
  + æŸä¸ªæºæ–‡ä»¶éœ€è¦ä¾èµ–å¦ä¸€ä¸ªæºæ–‡ä»¶æ—¶éœ€è¦æŠŠä¾èµ–æ”¾åœ¨å‰é¢(å³è¾¹)

## ðŸŽ‰åº“æ–‡ä»¶

> å¤šä¸ªç›®æ ‡æ–‡ä»¶`.o`æ‰“åŒ…åˆ°ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œæ ‡å‡†åº“ä¸€èˆ¬ä½äºŽ`/usr/lib`ã€`/lib`ã€`/usr/local/lib`ç›®å½•é‡Œï¼Œä»¥`.a`ä¸ºåŽç¼€å

 * é™æ€åº“ : åœ¨ç±»unixç³»ç»Ÿé‡Œä¸€èˆ¬ä»¥`.a`æ–‡ä»¶ä¸ºä¸»ï¼Œwindowsä¸­ä¸€èˆ¬ä»¥`.lib`æ–‡ä»¶ä¸ºä¸»
 * åŠ¨æ€åº“ : åœ¨linuxä¸­æ˜¯`.so`æ–‡ä»¶ï¼Œåœ¨windowsä¸­æ˜¯`.dll`æ–‡ä»¶

### ðŸ”—é“¾æŽ¥å¤–éƒ¨é™æ€åº“

> é€šè¿‡åœ¨å‘½ä»¤ä¸­æ·»åŠ åº“æ–‡ä»¶çš„è·¯å¾„(ä¸€èˆ¬æ˜¯ç›¸å¯¹è·¯å¾„)æ¥å¼•å…¥å¤–éƒ¨åº“ä¾èµ–

1. æ˜¾å¼æŒ‡å®šå¤–éƒ¨åº“æ–‡ä»¶

```bash
$ gcc -Wall main.c /usr/lib/libm.a -o calc
```

> âš ï¸æ³¨æ„: æŒ‡å®šåº“æ–‡ä»¶æ˜¯ï¼Œéœ€è¦æ³¨æ„æ–‡ä»¶ä¾èµ–é¡ºåº(å³->å·¦)

2. ä½¿ç”¨`-l`é€‰é¡¹æŒ‡å®šå¤–éƒ¨åº“æ–‡ä»¶

```bash
$ gcc -Wall main.c -lm -o calc
```

è¿™é‡Œçš„`-lm`ä¹Ÿæ˜¯ä¸€ä¸ªç»„åˆé€‰é¡¹ï¼Œä»Žç³»ç»Ÿåº“ç›®å½•æ‰¾æ–‡ä»¶ï¼Œè¡¨ç¤ºé“¾æŽ¥æ ‡å‡†åº“ç›®å½•`/usr/lib`

> âš ï¸æ³¨æ„: åœ¨ä½¿ç”¨åº“æ–‡ä»¶é‡Œé¢çš„å‡½æ•°æ—¶éœ€è¦åœ¨æºä»£ç ä¸­åŒ…å«ä½¿ç”¨åˆ°çš„åº“å‡½æ•°çš„å¤´æ–‡ä»¶ï¼Œå°±ç®—ä½ æ‰‹åŠ¨é“¾æŽ¥äº†ç›®æ ‡å‡½æ•°çš„åº“æ–‡ä»¶ï¼Œä¹Ÿä¼šæŠ¥é”™ï¼Œå› ä¸ºéœ€è¦æ˜¾å¼å£°æ˜Ž

3. æŒ‡å®šå¤–éƒ¨åº“ç›®å½•(âœ¨æŽ¨è)

ä¸éœ€è¦å¤–éƒ¨çŽ¯å¢ƒä¾èµ–ï¼Œä¸€èˆ¬åœ¨é¡¹ç›®ç›®å½•é‡Œåˆ›å»ºç›®å½•

* **`-I`** : æŒ‡å®šå¤´æ–‡ä»¶æœç´¢ç›®å½•

* **`-L`** : æŒ‡å®šåº“æ–‡ä»¶æœç´¢ç›®å½•

4. è®¾ç½®ç³»ç»ŸçŽ¯å¢ƒå˜é‡

* **`C_INCLUDE_PATH`** : æŒ‡å®šå¤´æ–‡ä»¶ç›®å½•

* **`LIBRARY_PATH`** : æŒ‡å®šåº“æ–‡ä»¶ç›®å½•


#### ðŸ”§æ‰‹åŠ¨åˆ›å»ºåº“æ–‡ä»¶

+ åˆ›å»ºåº“

```bash
$ ar cr lib_name.a file1.o file2.o file3.o
```

+ æŸ¥çœ‹åº“æ–‡ä»¶é‡Œæœ‰å¤šå°‘ä¸ªç›®æ ‡æ–‡ä»¶
```bash
$ ar t lib_name.a
```

### ðŸ˜„é“¾æŽ¥åŠ¨æ€åº“

> âš ï¸æ³¨æ„ï¼šå¦‚æžœæœ‰ä¸¤ä¸ªå†…å®¹ä¸€æ ·çš„åº“ï¼Œåˆ†åˆ«è¢«ç¼–è¯‘æˆé™æ€åº“å’ŒåŠ¨æ€åº“ï¼ŒGCCåœ¨éƒ½è¢«æŒ‡å®šæ—¶ï¼Œç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨åŠ¨æ€åº“æ¥é“¾æŽ¥

1. æŒ‡å®šçŽ¯å¢ƒå˜é‡

ç¨‹åºåœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šä»Žè¿™ä¸ªçŽ¯å¢ƒå˜é‡æŒ‡å®šçš„ç›®å½•å¯»æ‰¾åŠ¨æ€åº“æ–‡ä»¶

* **`LD_LIBRARY_PATH`** : é…ç½®åŠ¨æ€åº“æ–‡ä»¶ç›®å½•çš„çŽ¯å¢ƒå˜é‡

```bash
$ export LD_LIBRARY_PATH=/home/xxx/lib
```

## ðŸ‘¨â€ðŸ’»Cæ ‡å‡†æŒ‡å®š

é€šå¸¸ä¸åŒCæ ‡å‡†ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨è¯†åˆ«çš„cå…³é”®å­—ä¸åŒï¼ŒåŒ…å«ä¸åŒçš„åŠŸèƒ½ã€‚æ‰€ä»¥åœ¨ç¼–è¯‘æ—¶é’ˆå¯¹ä¸åŒæ ‡å‡†çš„æºä»£ç éœ€è¦æŒ‡å®šç¼–è¯‘æ ‡å‡†

é€šå¸¸æƒ…å†µä¸‹ä½¿ç”¨c99æ ‡å‡†

* **`-ansi`** : ä½¿ç”¨ansiæ ‡å‡†æ¥ç¼–è¯‘ï¼ˆæ ‡å‡†Cï¼‰

* **`-c99`** : ä½¿ç”¨c99æ ‡å‡†æ¥ç¼–è¯‘ï¼ˆå‡çº§ç‰ˆï¼‰

```bash
$ gcc -Wall -ansi -c main.c
```

æˆ–è€…

```bash
$ gcc -Wall -std=c99 -c main.c
```

> è¿˜æœ‰å¾ˆå¤šå…¶ä»–ç»†èŠ‚æŒ‡å®šé€‰é¡¹ç­‰ç”¨åˆ°çš„æ—¶å€™å†åŽ»æŸ¥ï¼Œæ¯”å¦‚ï¼š
> `-Wcomment`
> `-Wformat`
> `-Wunused`
> `-Wimplicit`
> `-Wreturn-type`


## âš“é¢„å¤„ç†å®

GCCç¼–è¯‘æ˜¯ä¼šå¯¹#å¼€å¤´çš„è¡Œæ£€æµ‹æ˜¯å¦å®å…³é”®å­—ï¼Œæ‰§è¡Œç›¸å…³è¯­ä¹‰çš„ç¼–è¯‘æ“ä½œ

### ðŸ¦½å®å®šä¹‰

* **`-D`** : å®å®šä¹‰é€‰é¡¹ï¼Œåœ¨ç¼–è¯‘æ—¶æŒ‡å®šä¸€ä¸ªå®

```bash
$ gcc -Wall -DNUM=123 main.c -o test
```

> åœ¨ç¼–è¯‘æ˜¯ä¼šå°†æŒ‡å®šçš„å®æ›¿æ¢åˆ°ä»£ç ä¸­ï¼Œæ•ˆæžœç›¸å½“äºŽï¼š`#define NUM 123`

å®è¡¨è¾¾å¼

```bash
$ gcc -Wall -DSUM="1+2" main.c -o test
```

ä»€ä¹ˆéƒ½ä¸å†™

```bash
$ gcc -Wall -DFLAG main.c -o test
```

> è¿™é‡Œç›¸å½“äºŽ`#define FLAG 1`ï¼Œå› ä¸ºå®šä¹‰äº†ä¸€ä¸ªç©ºçš„å®æ—¶ï¼Œé»˜è®¤å€¼å°±æ˜¯1

* **`-E`** : å¯ä»¥å°†æŒ‡å®šæºç é‡Œçš„å®æ›¿æ¢ä¸ºå®å®šä¹‰çš„å€¼(å®å±•å¼€)ï¼Œåœ¨åˆ†æžå¤æ‚ä»£ç æ—¶å¾ˆæœ‰ç”¨

```bash
$ gcc -Wall -E main.c
```

> è¿™ä¸ªè¿‡ç¨‹åªåšå®æ›¿æ¢åŽè¾“å‡º(é¢„å¤„ç†æ­¥éª¤)ï¼Œä¸ç¼–è¯‘


* **`-save-temps`** : ä¿å­˜ç¼–è¯‘è¿‡ç¨‹æ–‡ä»¶

```bash
$ gcc -Wall -save-temps -c main.c
```

> æ­¤é€‰é¡¹ä¼šå°†ç¼–è¯‘è¿‡ç¨‹ä¸´æ—¶æ–‡ä»¶é¢„å¤„ç†ç»“æžœä¿å­˜åˆ°`.i`æ–‡ä»¶ä¸­ï¼Œå°†æ±‡ç¼–ç»“æžœä¿å­˜åˆ°`.s`æ–‡ä»¶ä¸­

### ðŸš²æ¡ä»¶ç¼–è¯‘

* **`#if`** : å¦‚æžœå¸¸é‡è¡¨è¾¾å¼ä¸ºçœŸï¼Œåˆ™ç¼–è¯‘åŽç»­ä»£ç è‡³`#endif`ç­‰æŒ‡ä»¤ä¹‹é—´çš„ä»£ç å—

* **`#elif`** : ç±»ä¼¼äºŽ else ifï¼Œç”¨äºŽæä¾›å¤šä¸ªç¼–è¯‘æ¡ä»¶åˆ†æ”¯

* **`#else`** : ç”¨äºŽ `#if`ã€`#ifdef`æˆ– `#ifndef`çš„æœ€åŽä¸€ä¸ªåˆ†æ”¯

* **`#endif`** : ç»“æŸä¸€ä¸ªæ¡ä»¶ç¼–è¯‘å—

* **`#ifdef`** : å¦‚æžœæŒ‡å®šçš„å®å·²å®šä¹‰ï¼Œåˆ™ç¼–è¯‘åŽç»­ä»£ç 

* **`#ifndef`** : å¦‚æžœæŒ‡å®šçš„å®æœªå®šä¹‰ï¼Œåˆ™ç¼–è¯‘åŽç»­ä»£ç 

* **`#defined`** : å¯åœ¨ `#if`æˆ– `#elif`ä¸­ä½¿ç”¨çš„è¿ç®—ç¬¦ï¼Œç”¨äºŽæ£€æŸ¥å®æ˜¯å¦å·²å®šä¹‰


## ðŸ›ç¼–è¯‘è°ƒè¯•

* **`-g`** : åœ¨ç›®æ ‡å¯æ‰§è¡Œæ–‡ä»¶ä¸­ç”Ÿæˆä¸€äº›è°ƒè¯•çš„ä¿¡æ¯

| é€‰é¡¹   | æè¿°                                                                                  |
| :----- | :------------------------------------------------------------------------------------------------- |
| **-g** | **é»˜è®¤çº§åˆ«**ã€‚ç”Ÿæˆæ ‡å‡†è°ƒè¯•ä¿¡æ¯ï¼Œé€šå¸¸åŒ…æ‹¬å˜é‡ã€è¡Œå·ã€å‡½æ•°ç­‰åŸºæœ¬ä¿¡æ¯ã€‚åœ¨å¤§å¤šæ•° Linux ç³»ç»Ÿä¸Šï¼Œé»˜è®¤ç”Ÿæˆ DWARF æ ¼å¼çš„è°ƒè¯•ä¿¡æ¯ ã€‚ |
| **-g0** | **ä¸ç”Ÿæˆä»»ä½•è°ƒè¯•ä¿¡æ¯**ã€‚ç›¸å½“äºŽå®Œå…¨æ²¡æœ‰ `-g` é€‰é¡¹ ã€‚                                              |
| **-g1** | **ç”Ÿæˆæœ€å°‘çš„è°ƒè¯•ä¿¡æ¯**ã€‚ä»…åŒ…å«åŸºæœ¬çš„è¡Œå·å’Œå‡½æ•°ä¿¡æ¯ï¼Œä¸åŒ…æ‹¬å˜é‡æè¿°ç­‰ç»†èŠ‚ã€‚å¯èƒ½æ— æ³•æŸ¥çœ‹æ‰€æœ‰å˜é‡çš„å€¼ ã€‚        |
| **-g2** | ä¸Ž `-g` ç›¸åŒï¼Œç”Ÿæˆ**å®Œæ•´çš„æ ‡å‡†è°ƒè¯•ä¿¡æ¯**ï¼ˆåŒ…æ‹¬å˜é‡å’Œè¡Œå·ç­‰ï¼‰ï¼ŒæŽ¨èç”¨äºŽå¤§å¤šæ•°è°ƒè¯•åœºæ™¯ ã€‚                      |
| **-g3** | ç”Ÿæˆ**æœ€è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯**ï¼Œé™¤äº† `-g2` åŒ…å«çš„æ‰€æœ‰å†…å®¹å¤–ï¼Œè¿˜åŒ…æ‹¬**å®å®šä¹‰ä¿¡æ¯**ã€‚è¿™ä½¿å¾—åœ¨ GDB ä¸­å¯ä»¥æŸ¥çœ‹å’Œå±•å¼€å® ã€‚ |


```bash
$ gcc -Wall -g main.c -o test
```

| åœºæ™¯                           | æŽ¨èç¼–è¯‘é€‰é¡¹                     |
| :----------------------------- | :------------------------------- |
| **å¸¸è§„è°ƒè¯•**                   | `-g` æˆ– `-g2`                    |
| **éœ€è¦è°ƒè¯•å®**                 | `-g3`                            |
| **å¸Œæœ›è°ƒè¯•æ—¶ä»£ç æ›´æ˜“ç†è§£**     | `-g -O0` (é»˜è®¤)                  |
| **å¸Œæœ›åœ¨è°ƒè¯•æ—¶ä¹Ÿæœ‰è¾ƒå¥½æ€§èƒ½**   | `-g -Og`                         |
| **éœ€è¦æ£€æŸ¥æ±‡ç¼–æˆ–æžè‡´æ€§èƒ½è°ƒè¯•** | `-g -O2` (æ³¨æ„ä¼˜åŒ–å¯èƒ½å½±å“è°ƒè¯•)  |
| **ç”Ÿæˆæœ€ç»ˆå‘å¸ƒç‰ˆæœ¬**           | ä¸åŠ  `-g`ï¼Œæˆ–ç¼–è¯‘åŽä½¿ç”¨ `strip` |

* **`ulimit`å‘½ä»¤** ï¼š å¯ç”¨äºŽé…ç½®ç³»ç»Ÿç”Ÿæˆç¨‹åºå´©æºƒçž¬é—´çš„å†…å­˜ä¿¡æ¯

è¯¥å‘½ä»¤ç”¨æ¥è§£é™¤coredumpå¤§å°é™åˆ¶

> `coredump`æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼Œç¨‹åºæ‰§è¡Œçš„å°¸ä½“ã€‚åœ¨å†…å­˜ä¸­æ‰§è¡Œçš„ç¨‹åºå› ä¸ºé”™è¯¯æŒ‚æŽ‰äº†ï¼Œä¼šç”Ÿæˆè¯¥æ–‡ä»¶ã€‚ç”¨äºŽå¸®åŠ©å¼€å‘è€…å®šä½ç¨‹åºå´©æºƒåŽŸå› ã€‚é€šå¸¸ä½¿ç”¨GDBåˆ†æž

> æ³¨æ„ï¼›å¦‚æžœè§£é™¤äº†å¤§å°é™åˆ¶ï¼Œä¸»æœºç£ç›˜æœ‰å¯èƒ½è¢«å†™æ»¡

```bash
$ ulimit -c unlimited
```

| é€‰é¡¹ | å«ä¹‰                                                         | å•ä½                  |
| :--- | :----------------------------------------------------------- | :-------------------- |
| `-a` | **æ˜¾ç¤ºå½“å‰æ‰€æœ‰èµ„æºçš„é™åˆ¶è®¾ç½®**                               | -                     |
| `-c` | è®¾ç½® **core æ–‡ä»¶** çš„æœ€å¤§å¤§å°ï¼ˆå¸¸ç”¨äºŽç¨‹åºè°ƒè¯•ï¼‰              | 512 å­—èŠ‚å— (blocks)   |
| `-f` | è®¾ç½® Shell **å¯åˆ›å»ºæ–‡ä»¶**çš„æœ€å¤§å¤§å°                          | 512 å­—èŠ‚å— (blocks)   |
| `-n` | è®¾ç½®è¿›ç¨‹å¯ä»¥**åŒæ—¶æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦**çš„æœ€å¤§æ•°é‡ï¼ˆéžå¸¸é‡è¦ï¼‰     | ä¸ªæ•°                  |
| `-s` | è®¾ç½®è¿›ç¨‹çš„**å †æ ˆ**çš„æœ€å¤§å¤§å°                                  | KB                    |
| `-t` | è®¾ç½®è¿›ç¨‹å…è®¸ä½¿ç”¨çš„æœ€å¤§ **CPU æ—¶é—´**                          | ç§’                    |
| `--u` | è®¾ç½®ç”¨æˆ·æœ€å¤šå¯è¿è¡Œçš„**è¿›ç¨‹æ•°ç›®**                             | ä¸ªæ•°                  |
| `-l` | è®¾ç½®è¿›ç¨‹å¯ä»¥**é”å®šåœ¨å†…å­˜ä¸­**çš„æœ€å¤§å¤§å°                       | KB                    |
| `-v` | è®¾ç½®è¿›ç¨‹å¯ä½¿ç”¨çš„**è™šæ‹Ÿå†…å­˜**çš„æœ€å¤§å¤§å°                       | KB                    |
| `-H` | è®¾ç½®æŒ‡å®šèµ„æºçš„**ç¡¬é™åˆ¶**ï¼ˆä¸¥æ ¼ä¸Šé™ï¼Œé€šå¸¸åªæœ‰ root å¯æé«˜ï¼‰    |                       |
| `-S` | è®¾ç½®æŒ‡å®šèµ„æºçš„**è½¯é™åˆ¶**ï¼ˆå®žé™…ç”Ÿæ•ˆçš„é™åˆ¶ï¼Œç”¨æˆ·å¯è°ƒæ•´ç›´è‡³ç¡¬é™åˆ¶ï¼‰ |                       |

![æˆªå›¾](pic/004.png)

è¿è¡Œé”™è¯¯ç¨‹åº

![æˆªå›¾](pic/007.png)

æŸ¥çœ‹coredumpç”Ÿæˆçš„ç›®å½•
```bash
$ cat /proc/sys/kernel/core_pattern
```
![æˆªå›¾](pic/005.png)

å‘çŽ°ç³»ç»Ÿé…ç½®äº†systemd-coredumpï¼Œæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶é»˜è®¤ä¼šè¢«åŽ‹ç¼©å¹¶å­˜å‚¨åœ¨ /var/lib/systemd/coredump/ç›®å½•ä¸‹

![æˆªå›¾](pic/006.png)

è¿™é‡Œåªèƒ½é€‰æ‹©ä½¿ç”¨`coredumpctl`å·¥å…·æ¥æŸ¥çœ‹è¢«æ‰“åŒ…çš„zstæ–‡ä»¶

```bash
$ coredumpctl list
$ coredumpctl info bug
```

![æˆªå›¾](pic/008.png)


è°ƒè¯•coredumpï¼Œcoredumpctlå¯ä»¥è°ƒç”¨gdbæ¥è§£æž

```bash
$ coredumpctl debug bug
```

![æˆªå›¾](pic/009.png)

å¯¼å‡ºåŽŸå§‹coreæ–‡ä»¶ï¼Œç›´æŽ¥ä½¿ç”¨gdbæ¥è§£æž

```bash
$ coredumpctl -o core.dump dump bug
```

> coredumpctl -o <coredumpæ–‡ä»¶å> dump <è¢«æ‰“åŒ…çš„ç¨‹åºå>

ä½¿ç”¨gdbè°ƒè¯•

```bash
$ gdb bug core.bug
```

![æˆªå›¾](pic/010.png)
