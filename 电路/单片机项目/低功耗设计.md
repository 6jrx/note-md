在单片机（MCU）开发中，降低功耗是许多嵌入式系统（尤其是电池供电设备）的关键需求。以下是系统化的设计方法，涵盖硬件选型、软件优化和系统级策略：

---

### **一、硬件级优化**

#### 1. **选择低功耗MCU**

- **优先支持多种低功耗模式**：如STOP、SLEEP、STANDBY模式（STM32的Low-Power系列、ESP32的Light-sleep/Deep-sleep）。
- **选择低静态电流的MCU**：例如TI的MSP430、Silicon Labs的EFM32（功耗可低至0.1μA@Sleep）。
- **集成DC-DC/LDO的MCU**：如Nordic的nRF52系列（内置高效DC-DC，降低动态功耗）。

#### 2. **电源管理设计**

- **动态电压调节（DVS）**：根据负载调整MCU核心电压（如ARM Cortex-M的电压缩放）。
- **关闭未用外设电源**：通过MOS管或电源开关芯片控制外围电路供电。
- **低功耗LDO/DCDC选择**：如TPS7A02（静态电流仅25nA）。

#### 3. **外围电路优化**

- **降低传感器采样频率**：如将温湿度传感器从1Hz降至0.1Hz。
- **使用低功耗外设**：例如选择I²C接口的传感器（比SPI更省电）。
- **硬件去抖动**：用RC电路替代软件延时消抖，减少MCU唤醒次数。

---

### **二、软件级优化**

#### 1. **低功耗模式应用**

- **进入休眠模式**：在空闲时立即进入低功耗模式（如STM32的`HAL_PWR_EnterSLEEPMode()`）。
- **Tickless模式**：禁用系统节拍定时器（SysTick），避免周期性唤醒（FreeRTOS中配置`configUSE_TICKLESS_IDLE=1`）。
- **示例代码（STM32 HAL库）**：
  ```c_cpp
  HAL_SuspendTick();  // 停止SysTick
  HAL_PWR_EnterSTOPMode(PWR_LOWPOWERREGULATOR_ON, PWR_STOPENTRY_WFI);
  HAL_ResumeTick();   // 唤醒后恢复
  ```

#### 2. **中断驱动代替轮询**

- **事件唤醒**：通过外部中断（EXTI）、RTC闹钟或ADC阈值触发唤醒。
- **示例：RTC唤醒**：
  ```c_cpp
  HAL_RTC_SetAlarm(&hrtc, &sAlarm, RTC_FORMAT_BIN); // 设置RTC闹钟
  HAL_PWR_EnterSTANDBYMode(); // 进入待机模式
  ```

#### 3. **时钟与频率优化**

- **降低主频**：动态调整系统时钟（如从48MHz降至8MHz）。
- **关闭无用时钟**：禁用未用外设的时钟（STM32的`__HAL_RCC_GPIOA_CLK_DISABLE()`）。
- **使用低速时钟**：在休眠时切换至LSI（内部低速RC）或LSE（外部低速晶振）。

#### 4. **外设管理**

- **动态关闭外设**：使用后立即关闭ADC、UART等外设。
- **DMA传输**：减少CPU参与（如用DMA搬运传感器数据）。

#### 5. **代码优化**

- **减少运算复杂度**：用查表法替代实时计算（如CRC校验）。
- **短时高效运行**：唤醒后快速处理任务，立即返回休眠。

---

### **三、系统级策略**

#### 1. **任务调度优化**

- **合并任务**：将多个短任务集中处理，减少唤醒次数。
- **调整FreeRTOS任务优先级**：高优先级任务快速执行后进入休眠。

#### 2. **通信协议优化**

- **降低无线模块功耗**：LoRa/Wi-Fi/BLE采用间歇性发射（如BLE的Advertise Interval调至1s）。
- **数据压缩**：减少无线传输数据量（如使用Protobuf替代JSON）。

#### 3. **电源域划分**

- **分时供电**：通过PMOS控制不同模块的电源通断。
- **示例电路**：
  ```plaintext
  MCU GPIO ──┬─ PMOS ── Sensor_VCC
             └─ 10kΩ下拉电阻（确保默认关闭）
  ```

---

### **四、实测与调试**

1. **功耗测量工具**：
   - **电流探头**：如Keysight N6781A（可测μA级电流）。
   - **开发板功耗监测**：STM32CubeMonitor-Power。
2. **优化验证步骤**：
   - **基线测试**：记录初始功耗（如全速运行时的电流）。
   - **逐项关闭**：依次禁用外设、降低频率，观察功耗变化。
   - **示波器抓取波形**：检查唤醒期间的电流尖峰。
3. **典型功耗对比**（以STM32L4为例）：
   |模式|功耗|唤醒时间|
   |--|--|--|
   |Run（48MHz）|3.5mA|-|
   |Sleep|120μA|10μs|
   |Stop|1.5μA|1ms|
   |Standby|0.3μA|复位重启|

---

### **五、实战案例（智能水表）**

1. **需求**：
   - 每10分钟采集一次水流速，电池寿命需达10年。
2. **方案**：
   - **硬件**：STM32L051 + 霍尔流量计（中断触发）。
   - **软件**：
     - 主循环休眠，流量计脉冲触发EXTI唤醒。
     - 唤醒后累计脉冲数，通过LoRa每4小时上报一次数据。
   - **功耗结果**：
     - 平均电流：8μA（CR2032电池可支持12年）。

---

### **六、注意事项**

- **IO状态配置**：休眠前将未用IO设为模拟输入（避免漏电流）。
- **唤醒源选择**：优先用低功耗外设（如RTC替代定时器）。
- **固件更新机制**：预留低功耗模式下的OTA升级功能。

通过结合硬件选型、软件策略和系统设计，可显著降低MCU功耗，延长电池寿命至数年以上。
