在STM32F103（Cortex-M3内核）上实现按键的长按和短按功能，可以通过多种方法实现。以下是几种常见且高效的方案，结合了硬件配置、状态机和定时器的使用：

---

**一、基于定时器中断的扫描法**

1. 硬件配置  
• 按键连接GPIO（如PA0），配置为内部上拉输入，按下时接地形成低电平信号。
   
   • 启用定时器（如SysTick或TIM3），设置中断周期为5-10ms用于按键扫描。
2. 实现逻辑  
• 按键扫描：每次定时器中断触发时，读取GPIO状态。若按键按下（低电平），计数器递增；若松开则根据计数值判断长短按。
   
   • 阈值设定：短按（10ms-1秒）、长按（≥1秒）。
   
   • 示例代码片段：
   ```c_cpp
   void TIM3_IRQHandler() {
       static uint32_t key_press_count = 0;
       if (按键按下) key_press_count++;
       else {
           if (key_press_count > 200) {  // 长按（1秒）
               // 长按处理
           } else if (key_press_count > 20) {  // 短按（100ms）
               // 短按处理
           }
           key_press_count = 0;
       }
   }
   ```

---

**二、状态机法（高效且低资源占用）**

1. 状态划分  
• 初始状态：检测按键按下。
   
   • 确认状态：消抖后确认有效按下，启动计时。
   
   • 释放状态：根据计时结果触发长按或短按事件。
2. 关键步骤  
• 使用定时器中断周期（如10ms）驱动状态机。
   
   • 长按阈值设为1秒（计数值100次），短按阈值设为100ms（计数值10次）。
   
   • 代码示例：
   ```c_cpp
   typedef enum { KEY_CHECK, KEY_CONFIRM, KEY_RELEASE } KeyState;
   void Key_Scan() {
       static KeyState state = KEY_CHECK;
       static uint32_t press_time = 0;
       switch (state) {
           case KEY_CHECK:
               if (按键按下) state = KEY_CONFIRM;
               break;
           case KEY_CONFIRM:
               press_time++;
               if (press_time > 100) {  // 长按
                   state = KEY_RELEASE;
               } else if (按键松开) {
                   if (press_time > 10) {  // 短按
                       // 触发短按事件
                   }
                   press_time = 0;
                   state = KEY_CHECK;
               }
               break;
           // ...其他状态处理
       }
   }
   ```

---

**三、外部中断结合定时器法（实时性高）**

1. 硬件配置  
• 按键连接支持外部中断的GPIO（如EXTI线），配置为双边沿触发（下降沿按下，上升沿释放）。
   
   • 启用定时器记录按键持续时间。
2. 实现逻辑  
• 按下中断：记录开始时间，启动定时器。
   
   • 释放中断：停止定时器，计算时长并判断长短按。
   
   • 优势：减少主循环资源占用，适合实时性要求高的场景。

---

**四、软件消抖与非阻塞检测**

1. 主循环扫描  
• 在主循环中周期性检测按键状态（如每5ms），结合消抖延时（10-20ms）过滤抖动。
   
   • 示例：通过记录首次按下时间，结合当前时间差判断长按。
2. 代码优化  
• 避免使用阻塞延时（如`HAL_Delay`），改用非阻塞计时器。

---

**关键注意事项**

1. 消抖处理：软件消抖通常需10-20ms延时，可通过定时器或状态机实现。
2. 阈值调整：长按时间（1秒）和短按时间（100ms）需根据实际需求调整。
3. 资源优化：优先使用定时器中断或外部中断，减少主循环负担。

---

以上方法可根据具体需求选择。例如，简单应用可采用主循环扫描，复杂场景推荐状态机或外部中断结合定时器。实际代码需结合硬件配置（如GPIO模式、定时器频率）调整参数。
