## Java代码审计

### 一、fortify工具

<br/>

<br/>

### 二、审计点

#### 1）sql注入

- 针对部分老项目手写的jdbc连接。通常直接手动拼接的sql语句

- DAO层框架Mybaties如果经验不足，也可能造成sql注入漏洞
  - 在DAO层构造Paremeter入参的时候，使用%%符号等形式拼接like参数
  - 在构造参数时直接讲in查询的参数作为字符串传入

<br/>

#### 2）命令执行

- status2框架的ongl表达式可以解析传入的字符表达式，onglContext对象可以访问全局对象，执行代码。
- jsp的el表达式，也能直接调用对象造成RCE
- spring的spEL表达式解析文本命令造成RCE
- jndi注入，主要类lookup

<br/>

#### 3）XXE

- 接收解析xml格式的文本，作为xml实体对象执行。可以造成rce、内网探测等漏洞
  
  <br/>

#### 4）水平越权（横向越权）

- 当前用户权限恶意修改了其他用户的信息，通常是后端身份验证不够严格造成
  > 修复：用户在执行某些update操作时，应该使用token或session身份信息作为依据
  - 通过修改用户ID实现修改其他用户权限

#### 5）横向越权（纵向越权）

- 当前用户可以恶意操作更高权限的动作，通常在是参数里直接填写了权限登记的字段
  > 修复方法：校验当前用户所属权限，判断权限等级

<br/>

#### 6）XSS跨站脚本攻击

- 反射型
  > 攻击方法：在可以将用户传入的文本参数显示到页面并解析
- 存储型
- DOM型

<br/>

#### 7）CSRF跨站伪造攻击

- 在钓鱼网站页面中构造一个目标网站的http请求执行某update操作等动作。
  > 防御方法：检查Refrecer、设置随机token、自定义http请求头校验

<br/>

#### 8）文件上传漏洞

- 对上传的文件过滤不严，将文件直接保存到web服务目录下
- 下载文件时没有验证路径，导致可以下载任意目录的敏感文件

### 三、漏洞源码分析

#### 1）反序列化漏洞

*前提条件：*

> a、实现Serializable
> 
> b、重写readObject
> 
> c、readObject方法执行的恶意命令要可控
> 
> d、这个类必须存在于应用程序 类库 第三方的jar

<br/>

##### 0x01 log4j2

创建maven构建的java项目

<br/>

##### 0x02 Apache Commons Collections类反射漏洞

jdk1.8之后已修复代码

<br/>

##### 0x03 fastjson反序列化